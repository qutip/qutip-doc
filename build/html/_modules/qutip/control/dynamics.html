

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="None" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="None" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>qutip.control.dynamics &mdash; QuTiP: Quantum Toolbox in Python 4.2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> QuTiP: Quantum Toolbox in Python
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../frontmatter.html">Frontmatter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/guide.html">Users Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/apidoc.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../biblio.html">Bibliography</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">QuTiP: Quantum Toolbox in Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>qutip.control.dynamics</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for qutip.control.dynamics</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># This file is part of QuTiP: Quantum Toolbox in Python.</span>
<span class="c1">#</span>
<span class="c1">#    Copyright (c) 2014 and later, Alexander J G Pitchford</span>
<span class="c1">#    All rights reserved.</span>
<span class="c1">#</span>
<span class="c1">#    Redistribution and use in source and binary forms, with or without</span>
<span class="c1">#    modification, are permitted provided that the following conditions are</span>
<span class="c1">#    met:</span>
<span class="c1">#</span>
<span class="c1">#    1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c1">#       this list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1">#    2. Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#       notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#       documentation and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1">#    3. Neither the name of the QuTiP: Quantum Toolbox in Python nor the names</span>
<span class="c1">#       of its contributors may be used to endorse or promote products derived</span>
<span class="c1">#       from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1">#    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="c1">#    &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="c1">#    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A</span>
<span class="c1">#    PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="c1">#    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="c1">#    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="c1">#    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="c1">#    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="c1">#    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c1">#    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1">#    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">###############################################################################</span>

<span class="c1"># @author: Alexander Pitchford</span>
<span class="c1"># @email1: agp1@aber.ac.uk</span>
<span class="c1"># @email2: alex.pitchford@gmail.com</span>
<span class="c1"># @organization: Aberystwyth University</span>
<span class="c1"># @supervisor: Daniel Burgarth</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes that define the dynamics of the (quantum) system and target evolution</span>
<span class="sd">to be optimised.</span>
<span class="sd">The contols are also defined here, i.e. the dynamics generators (Hamiltonians,</span>
<span class="sd">Limbladians etc). The dynamics for the time slices are calculated here, along</span>
<span class="sd">with the evolution as determined by the control amplitudes.</span>

<span class="sd">See the subclass descriptions and choose the appropriate class for the</span>
<span class="sd">application. The choice depends on the type of matrix used to define</span>
<span class="sd">the dynamics.</span>

<span class="sd">These class implement functions for getting the dynamics generators for</span>
<span class="sd">the combined (drift + ctrls) dynamics with the approriate operator applied</span>

<span class="sd">Note the methods in these classes were inspired by:</span>
<span class="sd">DYNAMO - Dynamic Framework for Quantum Optimal Control</span>
<span class="sd">See Machnes et.al., arXiv.1011.4874</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="k">as</span> <span class="nn">la</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="c1"># QuTiP</span>
<span class="kn">from</span> <span class="nn">qutip</span> <span class="k">import</span> <span class="n">Qobj</span>
<span class="kn">from</span> <span class="nn">qutip.sparse</span> <span class="k">import</span> <span class="n">sp_eigs</span><span class="p">,</span> <span class="n">_dense_eigs</span>
<span class="kn">import</span> <span class="nn">qutip.settings</span> <span class="k">as</span> <span class="nn">settings</span>
<span class="c1"># QuTiP logging</span>
<span class="kn">import</span> <span class="nn">qutip.logging_utils</span> <span class="k">as</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<span class="c1"># QuTiP control modules</span>
<span class="kn">import</span> <span class="nn">qutip.control.errors</span> <span class="k">as</span> <span class="nn">errors</span>
<span class="kn">import</span> <span class="nn">qutip.control.tslotcomp</span> <span class="k">as</span> <span class="nn">tslotcomp</span>
<span class="kn">import</span> <span class="nn">qutip.control.fidcomp</span> <span class="k">as</span> <span class="nn">fidcomp</span>
<span class="kn">import</span> <span class="nn">qutip.control.propcomp</span> <span class="k">as</span> <span class="nn">propcomp</span>
<span class="kn">import</span> <span class="nn">qutip.control.symplectic</span> <span class="k">as</span> <span class="nn">sympl</span>
<span class="kn">import</span> <span class="nn">qutip.control.dump</span> <span class="k">as</span> <span class="nn">qtrldump</span>

<span class="n">DEF_NUM_TSLOTS</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">DEF_EVO_TIME</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="k">def</span> <span class="nf">_is_string</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">_check_ctrls_container</span><span class="p">(</span><span class="n">ctrls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check through the controls container.</span>
<span class="sd">    Convert to an array if its a list of lists</span>
<span class="sd">    return the processed container</span>
<span class="sd">    raise type error if the container structure is invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="c1"># Check to see if list of lists</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctrls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">ctrls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrls</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Incorrect shape for ctrl dyn gen array&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ctrls</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ctrls</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctrls</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">Qobj</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;All control dyn gen must be Qobj&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;All control dyn gen must be Qobj&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Controls list or array not set correctly&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ctrls</span>

<span class="k">def</span> <span class="nf">_check_drift_dyn_gen</span><span class="p">(</span><span class="n">drift</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drift</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drift</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;drift should be a Qobj or a list of Qobj&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drift</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;drift should be a Qobj or a list of Qobj&quot;</span><span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span> <span class="c1">#turn off filter</span>
<span class="k">def</span> <span class="nf">_attrib_deprecation</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Issue deprecation warning</span>
<span class="sd">    Using stacklevel=3 will ensure message refers the function</span>
<span class="sd">    calling with the deprecated parameter,</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_func_deprecation</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Issue deprecation warning</span>
<span class="sd">    Using stacklevel=3 will ensure message refers the function</span>
<span class="sd">    calling with the deprecated parameter,</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span><span class="p">)</span>

<div class="viewcode-block" id="Dynamics"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics">[docs]</a><span class="k">class</span> <span class="nc">Dynamics</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a base class only. See subclass descriptions and choose an</span>
<span class="sd">    appropriate one for the application.</span>

<span class="sd">    Note that initialize_controls must be called before most of the methods</span>
<span class="sd">    can be used. init_timeslots can be called sometimes earlier in order</span>
<span class="sd">    to access timeslot related attributes</span>

<span class="sd">    This acts as a container for the operators that are used to calculate</span>
<span class="sd">    time evolution of the system under study. That is the dynamics generators</span>
<span class="sd">    (Hamiltonians, Lindbladians etc), the propagators from one timeslot to</span>
<span class="sd">    the next, and the evolution operators. Due to the large number of matrix</span>
<span class="sd">    additions and multiplications, for small systems at least, the optimisation</span>
<span class="sd">    performance is much better using ndarrays to represent these operators.</span>
<span class="sd">    However</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    log_level : integer</span>
<span class="sd">        level of messaging output from the logger.</span>
<span class="sd">        Options are attributes of qutip.logging_utils,</span>
<span class="sd">        in decreasing levels of messaging, are:</span>
<span class="sd">        DEBUG_INTENSE, DEBUG_VERBOSE, DEBUG, INFO, WARN, ERROR, CRITICAL</span>
<span class="sd">        Anything WARN or above is effectively &#39;quiet&#39; execution,</span>
<span class="sd">        assuming everything runs as expected.</span>
<span class="sd">        The default NOTSET implies that the level will be taken from</span>
<span class="sd">        the QuTiP settings file, which by default is WARN</span>

<span class="sd">    params:  Dictionary</span>
<span class="sd">        The key value pairs are the attribute name and value</span>
<span class="sd">        Note: attributes are created if they do not exist already,</span>
<span class="sd">        and are overwritten if they do.</span>

<span class="sd">    stats : Stats</span>
<span class="sd">        Attributes of which give performance stats for the optimisation</span>
<span class="sd">        set to None to reduce overhead of calculating stats.</span>
<span class="sd">        Note it is (usually) shared with the Optimizer object</span>

<span class="sd">    tslot_computer : TimeslotComputer (subclass instance)</span>
<span class="sd">        Used to manage when the timeslot dynamics</span>
<span class="sd">        generators, propagators, gradients etc are updated</span>

<span class="sd">    prop_computer : PropagatorComputer (subclass instance)</span>
<span class="sd">        Used to compute the propagators and their gradients</span>

<span class="sd">    fid_computer : FidelityComputer (subclass instance)</span>
<span class="sd">        Used to computer the fidelity error and the fidelity error</span>
<span class="sd">        gradient.</span>

<span class="sd">    memory_optimization : int</span>
<span class="sd">        Level of memory optimisation. Setting to 0 (default) means that</span>
<span class="sd">        execution speed is prioritized over memory.</span>
<span class="sd">        Setting to 1 means that some memory prioritisation steps will be</span>
<span class="sd">        taken, for instance using Qobj (and hence sparse arrays) as the</span>
<span class="sd">        the internal operator data type, and not caching some operators</span>
<span class="sd">        Potentially further memory saving maybe made with</span>
<span class="sd">        memory_optimization &gt; 1.</span>
<span class="sd">        The options are processed in _set_memory_optimizations, see</span>
<span class="sd">        this for more information. Individual memory saving  options can be</span>
<span class="sd">        switched by settting them directly (see below)</span>

<span class="sd">    oper_dtype : type</span>
<span class="sd">        Data type for internal dynamics generators, propagators and time</span>
<span class="sd">        evolution operators. This can be ndarray or Qobj, or (in theory) any</span>
<span class="sd">        other representaion that supports typical matrix methods (e.g. dot)</span>
<span class="sd">        ndarray performs best for smaller quantum systems.</span>
<span class="sd">        Qobj may perform better for larger systems, and will also</span>
<span class="sd">        perform better when (custom) fidelity measures use Qobj methods</span>
<span class="sd">        such as partial trace.</span>
<span class="sd">        See _choose_oper_dtype for how this is chosen when not specified</span>

<span class="sd">    cache_phased_dyn_gen : bool</span>
<span class="sd">        If True then the dynamics generators will be saved with and</span>
<span class="sd">        without the propagation prefactor (if there is one)</span>
<span class="sd">        Defaults to True when memory_optimization=0, otherwise False</span>

<span class="sd">    cache_prop_grad : bool</span>
<span class="sd">        If the True then the propagator gradients (for exact gradients) will</span>
<span class="sd">        be computed when the propagator are computed and cache until</span>
<span class="sd">        the are used by the fidelity computer. If False then the</span>
<span class="sd">        fidelity computer will calculate them as needed.</span>
<span class="sd">        Defaults to True when memory_optimization=0, otherwise False</span>

<span class="sd">    cache_dyn_gen_eigenvectors_adj: bool</span>
<span class="sd">        If True then DynamicsUnitary will cached the adjoint of</span>
<span class="sd">        the Hamiltion eignvector matrix</span>
<span class="sd">        Defaults to True when memory_optimization=0, otherwise False</span>

<span class="sd">    sparse_eigen_decomp: bool</span>
<span class="sd">        If True then DynamicsUnitary will use the sparse eigenvalue</span>
<span class="sd">        decomposition.</span>
<span class="sd">        Defaults to True when memory_optimization&lt;=1, otherwise False</span>

<span class="sd">    num_tslots : integer</span>
<span class="sd">        Number of timeslots (aka timeslices)</span>

<span class="sd">    num_ctrls : integer</span>
<span class="sd">        Number of controls.</span>
<span class="sd">        Note this is calculated as the length of ctrl_dyn_gen when first used.</span>
<span class="sd">        And is recalculated during initialise_controls only.</span>

<span class="sd">    evo_time : float</span>
<span class="sd">        Total time for the evolution</span>

<span class="sd">    tau : array[num_tslots] of float</span>
<span class="sd">        Duration of each timeslot</span>
<span class="sd">        Note that if this is set before initialize_controls is called</span>
<span class="sd">        then num_tslots and evo_time are calculated from tau, otherwise</span>
<span class="sd">        tau is generated from num_tslots and evo_time, that is</span>
<span class="sd">        equal size time slices</span>

<span class="sd">    time : array[num_tslots+1] of float</span>
<span class="sd">        Cumulative time for the evolution, that is the time at the start</span>
<span class="sd">        of each time slice</span>

<span class="sd">    drift_dyn_gen : Qobj or list of Qobj</span>
<span class="sd">        Drift or system dynamics generator (Hamiltonian)</span>
<span class="sd">        Matrix defining the underlying dynamics of the system</span>
<span class="sd">        Can also be a list of Qobj (length num_tslots) for time varying</span>
<span class="sd">        drift dynamics</span>

<span class="sd">    ctrl_dyn_gen : List of Qobj</span>
<span class="sd">        Control dynamics generator (Hamiltonians)</span>
<span class="sd">        List of matrices defining the control dynamics</span>

<span class="sd">    initial : Qobj</span>
<span class="sd">        Starting state / gate</span>
<span class="sd">        The matrix giving the initial state / gate, i.e. at time 0</span>
<span class="sd">        Typically the identity for gate evolution</span>

<span class="sd">    target : Qobj</span>
<span class="sd">        Target state / gate:</span>
<span class="sd">        The matrix giving the desired state / gate for the evolution</span>

<span class="sd">    ctrl_amps : array[num_tslots, num_ctrls] of float</span>
<span class="sd">        Control amplitudes</span>
<span class="sd">        The amplitude (scale factor) for each control in each timeslot</span>

<span class="sd">    initial_ctrl_scaling : float</span>
<span class="sd">        Scale factor applied to be applied the control amplitudes</span>
<span class="sd">        when they are initialised</span>
<span class="sd">        This is used by the PulseGens rather than in any fucntions in</span>
<span class="sd">        this class</span>

<span class="sd">    initial_ctrl_offset  : float</span>
<span class="sd">        Linear offset applied to be applied the control amplitudes</span>
<span class="sd">        when they are initialised</span>
<span class="sd">        This is used by the PulseGens rather than in any fucntions in</span>
<span class="sd">        this class</span>

<span class="sd">    dyn_gen : List of Qobj</span>
<span class="sd">        Dynamics generators</span>
<span class="sd">        the combined drift and control dynamics generators</span>
<span class="sd">        for each timeslot</span>

<span class="sd">    prop : list of Qobj</span>
<span class="sd">        Propagators - used to calculate time evolution from one</span>
<span class="sd">        timeslot to the next</span>

<span class="sd">    prop_grad : array[num_tslots, num_ctrls] of Qobj</span>
<span class="sd">        Propagator gradient (exact gradients only)</span>
<span class="sd">        Array  of Qobj that give the gradient</span>
<span class="sd">        with respect to the control amplitudes in a timeslot</span>
<span class="sd">        Note this attribute is only created when the selected</span>
<span class="sd">        PropagatorComputer is an exact gradient type.</span>

<span class="sd">    fwd_evo : List of Qobj</span>
<span class="sd">        Forward evolution (or propagation)</span>
<span class="sd">        the time evolution operator from the initial state / gate to the</span>
<span class="sd">        specified timeslot as generated by the dyn_gen</span>

<span class="sd">    onwd_evo : List of Qobj</span>
<span class="sd">        Onward evolution (or propagation)</span>
<span class="sd">        the time evolution operator from the specified timeslot to</span>
<span class="sd">        end of the evolution time as generated by the dyn_gen</span>

<span class="sd">    onto_evo : List of Qobj</span>
<span class="sd">        &#39;Backward&#39; List of Qobj propagation</span>
<span class="sd">        the overlap of the onward propagation with the inverse of the</span>
<span class="sd">        target.</span>
<span class="sd">        Note this is only used (so far) by the unitary dynamics fidelity</span>

<span class="sd">    evo_current : Boolean</span>
<span class="sd">        Used to flag that the dynamics used to calculate the evolution</span>
<span class="sd">        operators is current. It is set to False when the amplitudes</span>
<span class="sd">        change</span>

<span class="sd">    fact_mat_round_prec : float</span>
<span class="sd">        Rounding precision used when calculating the factor matrix</span>
<span class="sd">        to determine if two eigenvalues are equivalent</span>
<span class="sd">        Only used when the PropagatorComputer uses diagonalisation</span>

<span class="sd">    def_amps_fname : string</span>
<span class="sd">        Default name for the output used when save_amps is called</span>

<span class="sd">    unitarity_check_level : int</span>
<span class="sd">        If &gt; 0 then unitarity of the system evolution is checked at at</span>
<span class="sd">        evolution recomputation.</span>
<span class="sd">        level 1 checks all propagators</span>
<span class="sd">        level 2 checks eigen basis as well</span>
<span class="sd">        Default is 0</span>

<span class="sd">    unitarity_tol :</span>
<span class="sd">        Tolerance used in checking if operator is unitary</span>
<span class="sd">        Default is 1e-10</span>

<span class="sd">    dump : :class:`dump.DynamicsDump`</span>
<span class="sd">        Store of historical calculation data.</span>
<span class="sd">        Set to None (Default) for no storing of historical data</span>
<span class="sd">        Use dumping property to set level of data dumping</span>

<span class="sd">    dumping : string</span>
<span class="sd">        level of data dumping: NONE, SUMMARY, FULL or CUSTOM</span>
<span class="sd">        See property docstring for details</span>

<span class="sd">    dump_to_file : bool</span>
<span class="sd">        If set True then data will be dumped to file during the calculations</span>
<span class="sd">        dumping will be set to SUMMARY during init_evo if dump_to_file is True</span>
<span class="sd">        and dumping not set.</span>
<span class="sd">        Default is False</span>

<span class="sd">    dump_dir : string</span>
<span class="sd">        Basically a link to dump.dump_dir. Exists so that it can be set through</span>
<span class="sd">        dyn_params.</span>
<span class="sd">        If dump is None then will return None or will set dumping to SUMMARY</span>
<span class="sd">        when setting a path</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimconfig</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">optimconfig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Link to optimiser object if self is linked to one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Main functional attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_amps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_ctrl_scaling</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_ctrl_offset</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evo_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># attributes used for processing evolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_optimization</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_phased_dyn_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_prop_grad</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dyn_gen_eigenvectors_adj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_eigen_decomp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_dims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_dims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_drift</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_ctrl_dyn_gen</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># These internal attributes will be of the internal operator data type</span>
        <span class="c1"># used to compute the evolution</span>
        <span class="c1"># Note this maybe ndarray, Qobj or some other depending on oper_dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drift_dyn_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phased_ctrl_dyn_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_application</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phased_dyn_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_onwd_evo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># The _qobj attribs are Qobj representations of the equivalent</span>
        <span class="c1"># internal attribute. They are only set when the extenal accessors</span>
        <span class="c1"># are used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target_qobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_qobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop_qobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad_qobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo_qobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_onwd_evo_qobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_qobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Atrributes used in diagonalisation</span>
        <span class="c1"># again in internal operator data type (see above)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decomp_curr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop_eigen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors_adj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_factormatrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fact_mat_round_prec</span> <span class="o">=</span> <span class="mf">1e-10</span>

        <span class="c1"># Debug and information attribs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_text</span> <span class="o">=</span> <span class="s1">&#39;DYN_BASE&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">def_amps_fname</span> <span class="o">=</span> <span class="s2">&quot;ctrl_amps.txt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">log_level</span>
        <span class="c1"># Internal flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_mapped</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evo_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeslots_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctrls_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen_checked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drift_dyn_gen_checked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Unitary checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unitarity_check_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unitarity_tol</span> <span class="o">=</span> <span class="mf">1e-10</span>
        <span class="c1"># Data dumping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_to_file</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">apply_params</span><span class="p">()</span>

        <span class="c1"># Create the computing objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_computers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="Dynamics.apply_params"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.apply_params">[docs]</a>    <span class="k">def</span> <span class="nf">apply_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set object attributes based on the dictionary (if any) passed in the</span>
<span class="sd">        instantiation, or passed as a parameter</span>
<span class="sd">        This is called during the instantiation automatically.</span>
<span class="sd">        The key value pairs are the attribute name and value</span>
<span class="sd">        Note: attributes are created if they do not exist already,</span>
<span class="sd">        and are overwritten if they do.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span>

    <span class="nd">@log_level</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">log_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lvl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the log_level attribute and set the level of the logger</span>
<span class="sd">        that is call logger.setLevel(lvl)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">lvl</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dumping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The level of data dumping that will occur during the time evolution</span>
<span class="sd">        calculation.</span>
<span class="sd">         - NONE : No processing data dumped (Default)</span>
<span class="sd">         - SUMMARY : A summary of each time evolution will be recorded</span>
<span class="sd">         - FULL : All operators used or created in the calculation dumped</span>
<span class="sd">         - CUSTOM : Some customised level of dumping</span>
<span class="sd">        When first set to CUSTOM this is equivalent to SUMMARY. It is then up</span>
<span class="sd">        to the user to specify which operators are dumped</span>
<span class="sd">        WARNING: FULL could consume a lot of memory!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lvl</span> <span class="o">=</span> <span class="s1">&#39;NONE&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="o">.</span><span class="n">level</span>

        <span class="k">return</span> <span class="n">lvl</span>

    <span class="nd">@dumping</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dumping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_string</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Value must be string value&quot;</span><span class="p">)</span>
            <span class="n">lvl</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lvl</span> <span class="o">==</span> <span class="s1">&#39;NONE&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">,</span> <span class="n">qtrldump</span><span class="o">.</span><span class="n">DynamicsDump</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">qtrldump</span><span class="o">.</span><span class="n">DynamicsDump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">lvl</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">lvl</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dump_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="o">.</span><span class="n">dump_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@dump_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dump_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumping</span> <span class="o">=</span> <span class="s1">&#39;SUMMARY&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="o">.</span><span class="n">dump_dir</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_create_computers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the default timeslot, fidelity and propagator computers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The time slot computer. By default it is set to UpdateAll</span>
        <span class="c1"># can be set to DynUpdate in the configuration</span>
        <span class="c1"># (see class file for details)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">tslot_type</span> <span class="o">==</span> <span class="s1">&#39;DYNAMIC&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tslot_computer</span> <span class="o">=</span> <span class="n">tslotcomp</span><span class="o">.</span><span class="n">TSlotCompDynUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tslot_computer</span> <span class="o">=</span> <span class="n">tslotcomp</span><span class="o">.</span><span class="n">TSlotCompUpdateAll</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prop_computer</span> <span class="o">=</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompFrechet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid_computer</span> <span class="o">=</span> <span class="n">fidcomp</span><span class="o">.</span><span class="n">FidCompTraceDiff</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_amps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evo_current</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid_computer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fid_computer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_tslots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeslots_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_timeslots</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span>

    <span class="nd">@num_tslots</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">num_tslots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeslots_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_timeslots</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evo_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeslots_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_timeslots</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evo_time</span>

    <span class="nd">@evo_time</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">evo_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evo_time</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeslots_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_timeslots</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tau</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeslots_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_timeslots</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span>

    <span class="nd">@tau</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">tau</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_timeslots</span><span class="p">()</span>

<div class="viewcode-block" id="Dynamics.init_timeslots"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.init_timeslots">[docs]</a>    <span class="k">def</span> <span class="nf">init_timeslots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the timeslot duration array &#39;tau&#39; based on the evo_time</span>
<span class="sd">        and num_tslots attributes, unless the tau attribute is already set</span>
<span class="sd">        in which case this step in ignored</span>
<span class="sd">        Generate the cumulative time array &#39;time&#39; based on the tau values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set the time intervals to be equal timeslices of the total if</span>
        <span class="c1"># the have not been set already (as part of user config)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span> <span class="o">=</span> <span class="n">DEF_NUM_TSLOTS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evo_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_evo_time</span> <span class="o">=</span> <span class="n">DEF_EVO_TIME</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">)</span> <span class="o">*</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_evo_time</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_evo_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1"># set the cumulative time by summing the time intervals</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_timeslots_initialized</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_set_memory_optimizations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set various memory optimisation attributes based on the</span>
<span class="sd">        memory_optimization attribute</span>
<span class="sd">        If they have been set already, e.g. in apply_params</span>
<span class="sd">        then they will not be overridden here</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting memory optimisations for level </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">memory_optimization</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_choose_oper_dtype</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Internal operator data type choosen to be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using operator data type </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_phased_dyn_gen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_optimization</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_phased_dyn_gen</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_phased_dyn_gen</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;phased dynamics generator caching </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cache_phased_dyn_gen</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_prop_grad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_optimization</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_prop_grad</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_prop_grad</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;propagator gradient caching </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cache_prop_grad</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dyn_gen_eigenvectors_adj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_optimization</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_dyn_gen_eigenvectors_adj</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_dyn_gen_eigenvectors_adj</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;eigenvector adjoint caching </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cache_dyn_gen_eigenvectors_adj</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_eigen_decomp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_optimization</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparse_eigen_decomp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparse_eigen_decomp</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;use sparse eigen decomp </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sparse_eigen_decomp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_choose_oper_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt select most efficient internal operator data type</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_optimization</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">=</span> <span class="n">Qobj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Method taken from Qobj.expm()</span>
            <span class="c1"># if method is not explicitly given, try to make a good choice</span>
            <span class="c1"># between sparse and dense solvers by considering the size of the</span>
            <span class="c1"># system and the number of non-zero elements.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_drift</span><span class="p">:</span>
                <span class="n">dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_ctrl_dyn_gen</span><span class="p">:</span>
                <span class="n">ctrls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctrls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
               <span class="n">dg</span> <span class="o">=</span> <span class="n">dg</span> <span class="o">+</span> <span class="n">c</span>

            <span class="n">N</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nnz</span>

            <span class="k">if</span> <span class="n">N</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">n</span><span class="p">:</span>
                <span class="c1"># large number of nonzero elements, revert to dense solver</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
            <span class="k">elif</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="c1"># large system, and quite sparse -&gt; qutips sparse method</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">=</span> <span class="n">Qobj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># small system, but quite sparse -&gt; qutips sparse/dense method</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span>

    <span class="k">def</span> <span class="nf">_init_evo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the container lists / arrays for the:</span>
<span class="sd">        dynamics generations, propagators, and evolutions etc</span>
<span class="sd">        Set the time slices and cumulative time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check evolution operators</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drift_dyn_gen_checked</span><span class="p">:</span>
            <span class="n">_check_drift_dyn_gen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen_checked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span> <span class="o">=</span> <span class="n">_check_ctrls_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;initial must be a Qobj&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;target must be a Qobj&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_drift_attribs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># Set the phase application method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_phase</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_memory_optimizations</span><span class="p">()</span>
        <span class="n">n_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span>
        <span class="n">n_ctrls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ctrls</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drift_dyn_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_drift</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drift_dyn_gen</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">full</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drift_dyn_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_ctrl_dyn_gen</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n_ts</span><span class="p">,</span> <span class="n">n_ctrls</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ts</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ctrls</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctrl</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
                                        <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_drift</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drift_dyn_gen</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drift_dyn_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span><span class="o">.</span><span class="n">data</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_ctrl_dyn_gen</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n_ts</span><span class="p">,</span> <span class="n">n_ctrls</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ts</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ctrls</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctrl</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown option &#39;</span><span class="si">{}</span><span class="s2">&#39; for oper_dtype. &quot;</span>
                <span class="s2">&quot;Assuming that internal drift, ctrls, initial and target &quot;</span>
                <span class="s2">&quot;have been set correctly&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_phased_dyn_gen</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_ctrl_dyn_gen</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_phased_ctrl_dyn_gen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n_ts</span><span class="p">,</span> <span class="n">n_ctrls</span><span class="p">],</span>
                                                     <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ts</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ctrls</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_phased_ctrl_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_phase</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_phased_ctrl_dyn_gen</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_phase</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span>
                                                <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_phased_dyn_gen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phased_dyn_gen</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_computer</span><span class="o">.</span><span class="n">grad_exact</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_prop_grad</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ctrls</span><span class="p">],</span>
                                      <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="c1"># Time evolution operator (forward propagation)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid_computer</span><span class="o">.</span><span class="n">uses_onwd_evo</span><span class="p">:</span>
            <span class="c1"># Time evolution operator (onward propagation)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_onwd_evo</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid_computer</span><span class="o">.</span><span class="n">uses_onto_evo</span><span class="p">:</span>
            <span class="c1"># Onward propagation overlap with inverse target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_onto_evo_target</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop_computer</span><span class="p">,</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompDiag</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_decomp_lists</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DynamicsUnitary</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unitarity_check_level</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_to_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dumping</span> <span class="o">=</span> <span class="s1">&#39;SUMMARY&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="o">.</span><span class="n">write_to_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="o">.</span><span class="n">create_dump_dir</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dynamics dump will be written to:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="o">.</span><span class="n">dump_dir</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_evo_initialized</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dyn_gen_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Some op that is applied to the dyn_gen before expontiating to</span>
<span class="sd">        get the propagator.</span>
<span class="sd">        See `phase_application` for how this is applied</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note that if this returns None then _apply_phase will never be</span>
        <span class="c1"># called</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span>

    <span class="nd">@dyn_gen_phase</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dyn_gen_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phase_application</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        phase_application : scalar(string), default=&#39;preop&#39;</span>
<span class="sd">        Determines how the phase is applied to the dynamics generators</span>
<span class="sd">         - &#39;preop&#39;  : P = expm(phase*dyn_gen)</span>
<span class="sd">         - &#39;postop&#39; : P = expm(dyn_gen*phase)</span>
<span class="sd">         - &#39;custom&#39; : Customised phase application</span>
<span class="sd">        The &#39;custom&#39; option assumes that the _apply_phase method has been</span>
<span class="sd">        set to a custom function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_application</span>

    <span class="nd">@phase_application</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">phase_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_phase_application</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_phase_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_phase_application</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_application</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_config_phase_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph_app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the appropriate function for the phase application</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Invalid value &#39;</span><span class="si">{}</span><span class="s2">&#39; for phase application. Must be either &quot;</span>
                   <span class="s2">&quot;&#39;preop&#39;, &#39;postop&#39; or &#39;custom&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ph_app</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">ph_app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph_app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_application</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ph_app</span> <span class="o">=</span> <span class="n">ph_app</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ph_app</span> <span class="o">==</span> <span class="s1">&#39;preop&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_phase_preop</span>
        <span class="k">elif</span> <span class="n">ph_app</span> <span class="o">==</span> <span class="s1">&#39;postop&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_phase_postop</span>
        <span class="k">elif</span> <span class="n">ph_app</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
            <span class="c1"># Do nothing, assume _apply_phase set elsewhere</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_gen_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_phase_application</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_phased_dyn_gen</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_apply_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This default method does nothing.</span>
<span class="sd">        It will be set to another method automatically if `phase_application`</span>
<span class="sd">        is &#39;preop&#39; or &#39;postop&#39;. It should be overridden repointed if</span>
<span class="sd">        `phase_application` is &#39;custom&#39;</span>
<span class="sd">        It will never be called if `dyn_gen_phase` is None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dg</span>

    <span class="k">def</span> <span class="nf">_apply_phase_preop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply phasing operator to dynamics generator.</span>
<span class="sd">        This called during the propagator calculation.</span>
<span class="sd">        In this case it will be applied as phase*dg</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_gen_phase</span><span class="p">,</span> <span class="s1">&#39;dot&#39;</span><span class="p">):</span>
            <span class="n">phased_dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phased_dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span><span class="o">*</span><span class="n">dg</span>
        <span class="k">return</span> <span class="n">phased_dg</span>

    <span class="k">def</span> <span class="nf">_apply_phase_postop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply phasing operator to dynamics generator.</span>
<span class="sd">        This called during the propagator calculation.</span>
<span class="sd">        In this case it will be applied as dg*phase</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_gen_phase</span><span class="p">,</span> <span class="s1">&#39;dot&#39;</span><span class="p">):</span>
            <span class="n">phased_dg</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phased_dg</span> <span class="o">=</span> <span class="n">dg</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span>
        <span class="k">return</span> <span class="n">phased_dg</span>

    <span class="k">def</span> <span class="nf">_create_decomp_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create lists that will hold the eigen decomposition</span>
<span class="sd">        used in calculating propagators and gradients</span>
<span class="sd">        Note: used with PropCompDiag propagator calcs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decomp_curr</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ts</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop_eigen</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ts</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ts</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dyn_gen_eigenvectors_adj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors_adj</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ts</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_factormatrix</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ts</span><span class="p">)]</span>

<div class="viewcode-block" id="Dynamics.initialize_controls"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.initialize_controls">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amps</span><span class="p">,</span> <span class="n">init_tslots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the initial control amplitudes and time slices</span>
<span class="sd">        Note this must be called after the configuration is complete</span>
<span class="sd">        before any dynamics can be calculated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop_computer</span><span class="p">,</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropagatorComputer</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                <span class="s2">&quot;No prop_computer (propagator computer) &quot;</span>
                <span class="s2">&quot;set. A default should be assigned by the Dynamics subclass&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tslot_computer</span><span class="p">,</span> <span class="n">tslotcomp</span><span class="o">.</span><span class="n">TimeslotComputer</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                <span class="s2">&quot;No tslot_computer (Timeslot computer)&quot;</span>
                <span class="s2">&quot; set. A default should be assigned by the Dynamics class&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid_computer</span><span class="p">,</span> <span class="n">fidcomp</span><span class="o">.</span><span class="n">FidelityComputer</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                <span class="s2">&quot;No fid_computer (Fidelity computer)&quot;</span>
                <span class="s2">&quot; set. A default should be assigned by the Dynamics subclass&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_amps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeslots_initialized</span><span class="p">:</span>
            <span class="n">init_tslots</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">init_tslots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_timeslots</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_evo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tslot_computer</span><span class="o">.</span><span class="n">init_comp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid_computer</span><span class="o">.</span><span class="n">init_comp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctrls_initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_ctrl_amps</span><span class="p">(</span><span class="n">amps</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">check_ctrls_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctrls_initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                <span class="s2">&quot;Controls not initialised. &quot;</span>
                <span class="s2">&quot;Ensure Dynamics.initialize_controls has been &quot;</span>
                <span class="s2">&quot;executed with the initial control amplitudes.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_amp_times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">]</span>

<div class="viewcode-block" id="Dynamics.save_amps"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.save_amps">[docs]</a>    <span class="k">def</span> <span class="nf">save_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save a file with the current control amplitudes in each timeslot</span>
<span class="sd">        The first column in the file will be the start time of the slot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name : string</span>
<span class="sd">            Name of the file</span>
<span class="sd">            If None given the def_amps_fname attribuite will be used</span>

<span class="sd">        times : List type (or string)</span>
<span class="sd">            List / array of the start times for each slot</span>
<span class="sd">            If None given this will be retrieved through get_amp_times()</span>
<span class="sd">            If &#39;exclude&#39; then times will not be saved in the file, just</span>
<span class="sd">            the amplitudes</span>

<span class="sd">        amps : Array[num_tslots, num_ctrls]</span>
<span class="sd">            Amplitudes to be saved</span>
<span class="sd">            If None given the ctrl_amps attribute will be used</span>

<span class="sd">        verbose : Boolean</span>
<span class="sd">            If True then an info message will be logged</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_ctrls_initialized</span><span class="p">()</span>

        <span class="n">inctimes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">def_amps_fname</span>
        <span class="k">if</span> <span class="n">amps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">amps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_amps</span>
        <span class="k">if</span> <span class="n">times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amp_times</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_string</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">times</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;exclude&#39;</span><span class="p">:</span>
                    <span class="n">inctimes</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown option for times &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                <span class="s2">&quot;when saving amplitudes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>
                    <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amp_times</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inctimes</span><span class="p">:</span>
                <span class="n">shp</span> <span class="o">=</span> <span class="n">amps</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">times</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">amps</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">amps</span>

            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%14.6g</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Amplitudes saved to file: &quot;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to save amplitudes due to underling &quot;</span>
                         <span class="s2">&quot;error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="Dynamics.update_ctrl_amps"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.update_ctrl_amps">[docs]</a>    <span class="k">def</span> <span class="nf">update_ctrl_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_amps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if any amplitudes have changed. If so, then mark the</span>
<span class="sd">        timeslots as needing recalculation</span>
<span class="sd">        The actual work is completed by the compare_amps method of the</span>
<span class="sd">        timeslot computer</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG_INTENSE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG_INTENSE</span><span class="p">,</span> <span class="s2">&quot;Updating amplitudes...</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;Current control amplitudes:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctrl_amps</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(potenially) new amplitudes:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_amps</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tslot_computer</span><span class="o">.</span><span class="n">compare_amps</span><span class="p">(</span><span class="n">new_amps</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dynamics.flag_system_changed"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.flag_system_changed">[docs]</a>    <span class="k">def</span> <span class="nf">flag_system_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flag evolution, fidelity and gradients as needing recalculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evo_current</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid_computer</span><span class="o">.</span><span class="n">flag_system_changed</span><span class="p">()</span></div>

<div class="viewcode-block" id="Dynamics.get_drift_dim"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.get_drift_dim">[docs]</a>    <span class="k">def</span> <span class="nf">get_drift_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the size of the matrix that defines the drift dynamics</span>
<span class="sd">        that is assuming the drift is NxN, then this returns N</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_drift_attribs</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Dynamics.refresh_drift_attribs"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.refresh_drift_attribs">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_drift_attribs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the dyn_shape, dyn_dims and time_depend_drift attribs&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">d0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_drift</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_drift</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unable to determine drift attributes, &quot;</span>
                    <span class="s2">&quot;because drift_dyn_gen is not Qobj (nor list of)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_shape</span> <span class="o">=</span> <span class="n">d0</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_dims</span> <span class="o">=</span> <span class="n">d0</span><span class="o">.</span><span class="n">dims</span></div>

<div class="viewcode-block" id="Dynamics.get_num_ctrls"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.get_num_ctrls">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculate the of controls from the length of the control list</span>
<span class="sd">        sets the num_ctrls property, which can be used alternatively</span>
<span class="sd">        subsequently</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_func_deprecation</span><span class="p">(</span><span class="s2">&quot;&#39;get_num_ctrls&#39; has been replaced by &quot;</span>
                         <span class="s2">&quot;&#39;num_ctrls&#39; property&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ctrls</span></div>

    <span class="k">def</span> <span class="nf">_get_num_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen_checked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span> <span class="o">=</span> <span class="n">_check_ctrls_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen_checked</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_ctrl_dyn_gen</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculate the of controls from the length of the control list</span>
<span class="sd">        sets the num_ctrls property, which can be used alternatively</span>
<span class="sd">        subsequently</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_num_ctrls</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">onto_evo_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_onto_evo_target</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target_qobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target_qobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rev_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target_qobj</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span><span class="p">,</span>
                                                  <span class="n">dims</span><span class="o">=</span><span class="n">rev_dims</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target_qobj</span>

    <span class="k">def</span> <span class="nf">get_owd_evo_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_func_deprecation</span><span class="p">(</span><span class="s2">&quot;&#39;get_owd_evo_target&#39; has been replaced by &quot;</span>
                         <span class="s2">&quot;&#39;onto_evo_target&#39; property&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">onto_evo_target</span>

    <span class="k">def</span> <span class="nf">_get_onto_evo_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the inverse of the target.</span>
<span class="sd">        Used for calculating the &#39;onto target&#39; evolution</span>
<span class="sd">        This is actually only relevant for unitary dynamics where</span>
<span class="sd">        the target.dag() is what is required</span>
<span class="sd">        However, for completeness, in general the inverse of the target</span>
<span class="sd">        operator is is required</span>
<span class="sd">        For state-to-state, the bra corresponding to the is required ket</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1">#Target is operator</span>
            <span class="n">targ</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">full</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">targ</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="n">targ</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">targ</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">targ_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="vm">__class__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="n">targ_cls</span><span class="p">(</span><span class="n">targ</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">targ_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="vm">__class__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="n">targ_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span><span class="o">.</span><span class="n">full</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span>

<div class="viewcode-block" id="Dynamics.combine_dyn_gen"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.combine_dyn_gen">[docs]</a>    <span class="k">def</span> <span class="nf">combine_dyn_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the dynamics generator for a given timeslot</span>
<span class="sd">        The is the combined Hamiltion for unitary systems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_func_deprecation</span><span class="p">(</span><span class="s2">&quot;&#39;combine_dyn_gen&#39; has been replaced by &quot;</span>
                        <span class="s2">&quot;&#39;_combine_dyn_gen&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combine_dyn_gen</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_combine_dyn_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the dynamics generator for a given timeslot</span>
<span class="sd">        The is the combined Hamiltion for unitary systems</span>
<span class="sd">        Also applies the phase (if any required by the propagation)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_drift</span><span class="p">:</span>
            <span class="n">dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drift_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drift_dyn_gen</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_ctrl_dyn_gen</span><span class="p">:</span>
                <span class="n">dg</span> <span class="o">=</span> <span class="n">dg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_amps</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dg</span> <span class="o">=</span> <span class="n">dg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_amps</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dg</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_phased_dyn_gen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phased_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_phase</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>

<div class="viewcode-block" id="Dynamics.get_dyn_gen"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.get_dyn_gen">[docs]</a>    <span class="k">def</span> <span class="nf">get_dyn_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the combined dynamics generator for the timeslot</span>
<span class="sd">        Not implemented in the base class. Choose a subclass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_func_deprecation</span><span class="p">(</span><span class="s2">&quot;&#39;get_dyn_gen&#39; has been replaced by &quot;</span>
                        <span class="s2">&quot;&#39;_get_phased_dyn_gen&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_phased_dyn_gen</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_phased_dyn_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_gen_phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phased_dyn_gen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phased_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

<div class="viewcode-block" id="Dynamics.get_ctrl_dyn_gen"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.get_ctrl_dyn_gen">[docs]</a>    <span class="k">def</span> <span class="nf">get_ctrl_dyn_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the dynamics generator for the control</span>
<span class="sd">        Not implemented in the base class. Choose a subclass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_func_deprecation</span><span class="p">(</span><span class="s2">&quot;&#39;get_ctrl_dyn_gen&#39; has been replaced by &quot;</span>
                        <span class="s2">&quot;&#39;_get_phased_ctrl_dyn_gen&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_phased_ctrl_dyn_gen</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_phased_ctrl_dyn_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phased_ctrl_dyn_gen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_ctrl_dyn_gen</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phased_ctrl_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phased_ctrl_dyn_gen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_depend_ctrl_dyn_gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_gen_phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_gen_phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctrl_dyn_gen</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dyn_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of combined dynamics generators (Qobj) for each timeslot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_qobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_qobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_qobj</span> <span class="o">=</span> <span class="p">[</span><span class="n">Qobj</span><span class="p">(</span><span class="n">dg</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_dims</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">dg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_qobj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of propagators (Qobj) for each timeslot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop_qobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prop_qobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prop_qobj</span> <span class="o">=</span> <span class="p">[</span><span class="n">Qobj</span><span class="p">(</span><span class="n">dg</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_dims</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">dg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop_qobj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prop_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Array of propagator gradients (Qobj) for each timeslot, control</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad_qobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad_qobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad_qobj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ctrls</span><span class="p">],</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ctrls</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad_qobj</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                                                    <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_dims</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad_qobj</span>

    <span class="k">def</span> <span class="nf">_get_prop_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_prop_grad</span><span class="p">:</span>
            <span class="n">prop_grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop_grad</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prop_grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_computer</span><span class="o">.</span><span class="n">_compute_prop_grad</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
                                                       <span class="n">compute_prop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prop_grad</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evo_init2t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_attrib_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;&#39;evo_init2t&#39; has been replaced by &#39;_fwd_evo&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fwd_evo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of evolution operators (Qobj) from the initial to the given</span>
<span class="sd">        timeslot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo_qobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo_qobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo_qobj</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo_qobj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Qobj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                                       <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_dims</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo_qobj</span>

    <span class="k">def</span> <span class="nf">_get_full_evo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_tslots</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full_evo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Full evolution - time evolution at final time slot&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwd_evo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evo_t2end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_attrib_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;&#39;evo_t2end&#39; has been replaced by &#39;_onwd_evo&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onwd_evo</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">onwd_evo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of evolution operators (Qobj) from the initial to the given</span>
<span class="sd">        timeslot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onwd_evo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onwd_evo_qobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_onwd_evo_qobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_evo</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_onwd_evo_qobj</span> <span class="o">=</span> <span class="p">[</span><span class="n">Qobj</span><span class="p">(</span><span class="n">dg</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_dims</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">dg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onwd_evo</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onwd_evo_qobj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evo_t2targ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_attrib_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;&#39;evo_t2targ&#39; has been replaced by &#39;_onto_evo&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">onto_evo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of evolution operators (Qobj) from the initial to the given</span>
<span class="sd">        timeslot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_qobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_qobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_qobj</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_qobj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Qobj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                                       <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_dims</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_qobj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onto_evo_target</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_qobj</span>

<div class="viewcode-block" id="Dynamics.compute_evolution"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.compute_evolution">[docs]</a>    <span class="k">def</span> <span class="nf">compute_evolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recalculate the time evolution operators</span>
<span class="sd">        Dynamics generators (e.g. Hamiltonian) and</span>
<span class="sd">        prop (propagators) are calculated as necessary</span>
<span class="sd">        Actual work is completed by the recompute_evolution method</span>
<span class="sd">        of the timeslot computer</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if values are already current, otherwise calculate all values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">evo_current</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG_VERBOSE</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG_VERBOSE</span><span class="p">,</span> <span class="s2">&quot;Computing evolution&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tslot_computer</span><span class="o">.</span><span class="n">recompute_evolution</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evo_current</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_ensure_decomp_curr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks to see if the diagonalisation has been completed since</span>
<span class="sd">        the last update of the dynamics generators</span>
<span class="sd">        (after the amplitude update)</span>
<span class="sd">        If not then the diagonlisation is completed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomp_curr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s2">&quot;Decomp lists have not been created&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomp_curr</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spectral_decomp</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_spectral_decomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the diagonalization of the dynamics generator</span>
<span class="sd">        generating lists of eigenvectors, propagators in the diagonalised</span>
<span class="sd">        basis, and the &#39;factormatrix&#39; used in calculating the propagator</span>
<span class="sd">        gradient</span>
<span class="sd">        Not implemented in this base class, because the method is specific</span>
<span class="sd">        to the matrix type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s2">&quot;Decomposition cannot be completed by &quot;</span>
                                <span class="s2">&quot;this class. Try a(nother) subclass&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_unitary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether operator A is unitary</span>
<span class="sd">        A can be either Qobj or ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="n">unitary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">A</span><span class="o">*</span><span class="n">A</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span><span class="o">.</span><span class="n">full</span><span class="p">(),</span>
                        <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unitarity_tol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unitary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)),</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">()),</span>
                        <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unitarity_tol</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">unitary</span>

    <span class="k">def</span> <span class="nf">_calc_unitary_err</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">A</span><span class="o">*</span><span class="n">A</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span><span class="o">.</span><span class="n">full</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">))</span> <span class="o">-</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">())))</span>

        <span class="k">return</span> <span class="n">err</span>

<div class="viewcode-block" id="Dynamics.unitarity_check"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.Dynamics.unitarity_check">[docs]</a>    <span class="k">def</span> <span class="nf">unitarity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether all propagators are unitary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_unitary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Progator of timeslot </span><span class="si">{}</span><span class="s2"> is not unitary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="DynamicsGenMat"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.DynamicsGenMat">[docs]</a><span class="k">class</span> <span class="nc">DynamicsGenMat</span><span class="p">(</span><span class="n">Dynamics</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This sub class can be used for any system where no additional</span>
<span class="sd">    operator is applied to the dynamics generator before calculating</span>
<span class="sd">    the propagator, e.g. classical dynamics, Lindbladian</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Dynamics</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_text</span> <span class="o">=</span> <span class="s1">&#39;GEN_MAT&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_params</span><span class="p">()</span></div>

<div class="viewcode-block" id="DynamicsUnitary"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.DynamicsUnitary">[docs]</a><span class="k">class</span> <span class="nc">DynamicsUnitary</span><span class="p">(</span><span class="n">Dynamics</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the subclass to use for systems with dynamics described by</span>
<span class="sd">    unitary matrices. E.g. closed systems with Hermitian Hamiltonians</span>
<span class="sd">    Note a matrix diagonalisation is used to compute the exponent</span>
<span class="sd">    The eigen decomposition is also used to calculate the propagator gradient.</span>
<span class="sd">    The method is taken from DYNAMO (see file header)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    drift_ham : Qobj</span>
<span class="sd">        This is the drift Hamiltonian for unitary dynamics</span>
<span class="sd">        It is mapped to drift_dyn_gen during initialize_controls</span>

<span class="sd">    ctrl_ham : List of Qobj</span>
<span class="sd">        These are the control Hamiltonians for unitary dynamics</span>
<span class="sd">        It is mapped to ctrl_dyn_gen during initialize_controls</span>

<span class="sd">    H : List of Qobj</span>
<span class="sd">        The combined drift and control Hamiltonians for each timeslot</span>
<span class="sd">        These are the dynamics generators for unitary dynamics.</span>
<span class="sd">        It is mapped to dyn_gen during initialize_controls</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Dynamics</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_text</span> <span class="o">=</span> <span class="s1">&#39;UNIT&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_ham</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_ham</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_application</span> <span class="o">=</span> <span class="s1">&#39;preop&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_params</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_computers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the default timeslot, fidelity and propagator computers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The time slot computer. By default it is set to _UpdateAll</span>
        <span class="c1"># can be set to _DynUpdate in the configuration</span>
        <span class="c1"># (see class file for details)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">tslot_type</span> <span class="o">==</span> <span class="s1">&#39;DYNAMIC&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tslot_computer</span> <span class="o">=</span> <span class="n">tslotcomp</span><span class="o">.</span><span class="n">TSlotCompDynUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tslot_computer</span> <span class="o">=</span> <span class="n">tslotcomp</span><span class="o">.</span><span class="n">TSlotCompUpdateAll</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># set the default fidelity computer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid_computer</span> <span class="o">=</span> <span class="n">fidcomp</span><span class="o">.</span><span class="n">FidCompUnitary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># set the default propagator computer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop_computer</span> <span class="o">=</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompDiag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="DynamicsUnitary.initialize_controls"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.DynamicsUnitary.initialize_controls">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">init_tslots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Either the _dyn_gen or _ham names can be used</span>
        <span class="c1"># This assumes that one or other has been set in the configuration</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_map_dyn_gen_to_ham</span><span class="p">()</span>
        <span class="n">Dynamics</span><span class="o">.</span><span class="n">initialize_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">init_tslots</span><span class="o">=</span><span class="n">init_tslots</span><span class="p">)</span></div>
        <span class="c1">#self.H = self._dyn_gen</span>

    <span class="k">def</span> <span class="nf">_map_dyn_gen_to_ham</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_ham</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drift_ham</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_dyn_gen</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_ham</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_ham</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_mapped</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_mapped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_map_dyn_gen_to_ham</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_num_ctrls</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_ctrls</span>

    <span class="k">def</span> <span class="nf">_get_onto_evo_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the adjoint of the target.</span>
<span class="sd">        Used for calculating the &#39;backward&#39; evolution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onto_evo_target</span>

    <span class="k">def</span> <span class="nf">_spectral_decomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the diagonalization of the dynamics generator</span>
<span class="sd">        generating lists of eigenvectors, propagators in the diagonalised</span>
<span class="sd">        basis, and the &#39;factormatrix&#39; used in calculating the propagator</span>
<span class="sd">        gradient</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="c1"># Returns eigenvalues as array (row)</span>
            <span class="c1"># and eigenvectors as rows of an array</span>
            <span class="n">eig_val</span><span class="p">,</span> <span class="n">eig_vec</span> <span class="o">=</span> <span class="n">sp_eigs</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">isherm</span><span class="p">,</span>
                                       <span class="n">sparse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_eigen_decomp</span><span class="p">)</span>
            <span class="n">eig_vec</span> <span class="o">=</span> <span class="n">eig_vec</span><span class="o">.</span><span class="n">T</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="c1"># returns row vector of eigenvals, columns with the eigenvecs</span>
            <span class="n">eig_val</span><span class="p">,</span> <span class="n">eig_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
                <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="c1"># returns row vector of eigenvals, columns with the eigenvecs</span>
            <span class="n">eig_val</span><span class="p">,</span> <span class="n">eig_vec</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>

        <span class="c1"># assuming H is an nxn matrix, find n</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_drift_dim</span><span class="p">()</span>

        <span class="c1"># Calculate the propagator in the diagonalised basis</span>
        <span class="n">eig_val_tau</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">eig_val</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">prop_eig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">eig_val_tau</span><span class="p">)</span>

        <span class="c1"># Generate the factor matrix through the differences</span>
        <span class="c1"># between each of the eigenvectors and the exponentiations</span>
        <span class="c1"># create nxn matrix where each eigen val is repeated n times</span>
        <span class="c1"># down the columns</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
        <span class="n">eig_val_cols</span> <span class="o">=</span> <span class="n">eig_val_tau</span><span class="o">*</span><span class="n">o</span>
        <span class="c1"># calculate all the differences by subtracting it from its transpose</span>
        <span class="n">eig_val_diffs</span> <span class="o">=</span> <span class="n">eig_val_cols</span> <span class="o">-</span> <span class="n">eig_val_cols</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># repeat for the propagator</span>
        <span class="n">prop_eig_cols</span> <span class="o">=</span> <span class="n">prop_eig</span><span class="o">*</span><span class="n">o</span>
        <span class="n">prop_eig_diffs</span> <span class="o">=</span> <span class="n">prop_eig_cols</span> <span class="o">-</span> <span class="n">prop_eig_cols</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># the factor matrix is the elementwise quotient of the</span>
        <span class="c1"># differeneces between the exponentiated eigen vals and the</span>
        <span class="c1"># differences between the eigen vals</span>
        <span class="c1"># need to avoid division by zero that would arise due to denegerate</span>
        <span class="c1"># eigenvalues and the diagonals</span>
        <span class="n">degen_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eig_val_diffs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fact_mat_round_prec</span>
        <span class="n">eig_val_diffs</span><span class="p">[</span><span class="n">degen_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">prop_eig_diffs</span> <span class="o">/</span> <span class="n">eig_val_diffs</span>
        <span class="c1"># for degenerate eigenvalues the factor is just the exponent</span>
        <span class="n">factors</span><span class="p">[</span><span class="n">degen_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop_eig_cols</span><span class="p">[</span><span class="n">degen_mask</span><span class="p">]</span>

        <span class="c1"># Store eigenvectors, propagator and factor matric</span>
        <span class="c1"># for use in propagator computations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decomp_curr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_factormatrix</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">factors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_factormatrix</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prop_eigen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagflat</span><span class="p">(</span><span class="n">prop_eig</span><span class="p">),</span>
                                                    <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_dims</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">eig_vec</span><span class="p">,</span>
                                                <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_dims</span><span class="p">)</span>
            <span class="c1"># The _dyn_gen_eigenvectors_adj list is not used in</span>
            <span class="c1"># memory optimised modes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors_adj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors_adj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prop_eigen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagflat</span><span class="p">(</span><span class="n">prop_eig</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eig_vec</span>
            <span class="c1"># The _dyn_gen_eigenvectors_adj list is not used in</span>
            <span class="c1"># memory optimised modes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors_adj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors_adj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">_get_dyn_gen_eigenvectors_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="c1"># The _dyn_gen_eigenvectors_adj list is not used in</span>
        <span class="c1"># memory optimised modes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors_adj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors_adj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

<div class="viewcode-block" id="DynamicsUnitary.check_unitarity"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.DynamicsUnitary.check_unitarity">[docs]</a>    <span class="k">def</span> <span class="nf">check_unitarity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether all propagators are unitary</span>
<span class="sd">        For propagators found not to be unitary, the potential underlying</span>
<span class="sd">        causes are investigated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">):</span>
            <span class="n">prop_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_unitary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prop_unit</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Progator of timeslot </span><span class="si">{}</span><span class="s2"> is not unitary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prop_unit</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">unitarity_check_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Check Hamiltonian</span>
                <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
                    <span class="n">herm</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">isherm</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">H</span><span class="p">)</span>
                    <span class="n">herm</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">atol</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>
                <span class="n">eigval_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_unitary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prop_eigen</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">eigvec_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_unitary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors_adj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">eigvecadj_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_unitary</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_eigenvectors_adj</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">eigvecadj_unit</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;prop unit: </span><span class="si">{}</span><span class="s2">; H herm: </span><span class="si">{}</span><span class="s2">; &quot;</span>
                        <span class="s2">&quot;eigval unit: </span><span class="si">{}</span><span class="s2">; eigvec unit: </span><span class="si">{}</span><span class="s2">; &quot;</span>
                        <span class="s2">&quot;eigvecadj_unit: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">prop_unit</span><span class="p">,</span> <span class="n">herm</span><span class="p">,</span> <span class="n">eigval_unit</span><span class="p">,</span> <span class="n">eigvec_unit</span><span class="p">,</span>
                            <span class="n">eigvecadj_unit</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="DynamicsSymplectic"><a class="viewcode-back" href="../../../apidoc/classes.html#qutip.control.dynamics.DynamicsSymplectic">[docs]</a><span class="k">class</span> <span class="nc">DynamicsSymplectic</span><span class="p">(</span><span class="n">Dynamics</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Symplectic systems</span>
<span class="sd">    This is the subclass to use for systems where the dynamics is described</span>
<span class="sd">    by symplectic matrices, e.g. coupled oscillators, quantum optics</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    omega : array[drift_dyn_gen.shape]</span>
<span class="sd">        matrix used in the calculation of propagators (time evolution)</span>
<span class="sd">        with symplectic systems.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Dynamics</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_text</span> <span class="o">=</span> <span class="s1">&#39;SYMPL&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_omega</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_omega_qobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_application</span> <span class="o">=</span> <span class="s1">&#39;postop&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_exact</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_params</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_computers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the default timeslot, fidelity and propagator computers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The time slot computer. By default it is set to _UpdateAll</span>
        <span class="c1"># can be set to _DynUpdate in the configuration</span>
        <span class="c1"># (see class file for details)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">tslot_type</span> <span class="o">==</span> <span class="s1">&#39;DYNAMIC&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tslot_computer</span> <span class="o">=</span> <span class="n">tslotcomp</span><span class="o">.</span><span class="n">TSlotCompDynUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tslot_computer</span> <span class="o">=</span> <span class="n">tslotcomp</span><span class="o">.</span><span class="n">TSlotCompUpdateAll</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prop_computer</span> <span class="o">=</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompFrechet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid_computer</span> <span class="o">=</span> <span class="n">fidcomp</span><span class="o">.</span><span class="n">FidCompTraceDiff</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">omega</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omega</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_omega</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omega_qobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_omega_qobj</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_omega</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_dims</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omega_qobj</span>

    <span class="k">def</span> <span class="nf">_get_omega</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omega</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_drift_dim</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">omg</span> <span class="o">=</span> <span class="n">sympl</span><span class="o">.</span><span class="n">calc_omega</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">Qobj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_omega</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">omg</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_dims</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_omega_qobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omega</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">oper_dtype</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_omega</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">omg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_omega</span> <span class="o">=</span> <span class="n">omg</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omega</span>

    <span class="k">def</span> <span class="nf">_set_phase_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">Dynamics</span><span class="o">.</span><span class="n">_set_phase_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evo_initialized</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dyn_gen_phase</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span> <span class="o">=</span> <span class="n">phase</span>

    <span class="k">def</span> <span class="nf">_get_dyn_gen_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_application</span> <span class="o">==</span> <span class="s1">&#39;postop&#39;</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_omega</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_application</span> <span class="o">==</span> <span class="s1">&#39;preop&#39;</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_omega</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_application</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Assume phase set by user</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No option for phase_application &quot;</span>
                             <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_application</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">phase</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dyn_gen_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The phasing operator for the symplectic group generators</span>
<span class="sd">        usually refered to as \Omega</span>
<span class="sd">        By default this is applied as &#39;postop&#39; dyn_gen*-\Omega</span>
<span class="sd">        If phase_application is &#39;preop&#39; it is applied as \Omega*dyn_gen</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Cannot be calculated until the dyn_shape is set</span>
        <span class="c1"># that is after the drift dyn gen has been set.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dyn_gen_phase</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyn_gen_phase</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, P.D. Nation, J.R. Johansson, A.J.G. Pitchford, C. Granade, and A.L. Grimsmo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>