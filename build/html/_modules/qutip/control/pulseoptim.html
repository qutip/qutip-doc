

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="None" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="None" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>qutip.control.pulseoptim &mdash; QuTiP: Quantum Toolbox in Python 4.2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> QuTiP: Quantum Toolbox in Python
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../frontmatter.html">Frontmatter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/guide.html">Users Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/apidoc.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../biblio.html">Bibliography</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">QuTiP: Quantum Toolbox in Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>qutip.control.pulseoptim</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for qutip.control.pulseoptim</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># This file is part of QuTiP: Quantum Toolbox in Python.</span>
<span class="c1">#</span>
<span class="c1">#    Copyright (c) 2014 and later, Alexander J G Pitchford</span>
<span class="c1">#    All rights reserved.</span>
<span class="c1">#</span>
<span class="c1">#    Redistribution and use in source and binary forms, with or without</span>
<span class="c1">#    modification, are permitted provided that the following conditions are</span>
<span class="c1">#    met:</span>
<span class="c1">#</span>
<span class="c1">#    1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c1">#       this list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1">#    2. Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#       notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#       documentation and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1">#    3. Neither the name of the QuTiP: Quantum Toolbox in Python nor the names</span>
<span class="c1">#       of its contributors may be used to endorse or promote products derived</span>
<span class="c1">#       from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1">#    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="c1">#    &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="c1">#    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A</span>
<span class="c1">#    PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="c1">#    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="c1">#    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="c1">#    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="c1">#    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="c1">#    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c1">#    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1">#    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">###############################################################################</span>

<span class="c1"># @author: Alexander Pitchford</span>
<span class="c1"># @email1: agp1@aber.ac.uk</span>
<span class="c1"># @email2: alex.pitchford@gmail.com</span>
<span class="c1"># @organization: Aberystwyth University</span>
<span class="c1"># @supervisor: Daniel Burgarth</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Wrapper functions that will manage the creation of the objects,</span>
<span class="sd">build the configuration, and execute the algorithm required to optimise</span>
<span class="sd">a set of ctrl pulses for a given (quantum) system.</span>
<span class="sd">The fidelity error is some measure of distance of the system evolution</span>
<span class="sd">from the given target evolution in the time allowed for the evolution.</span>
<span class="sd">The functions minimise this fidelity error wrt the piecewise control</span>
<span class="sd">amplitudes in the timeslots</span>

<span class="sd">There are currently two quantum control pulse optmisations algorithms</span>
<span class="sd">implemented in this library. There are accessible through the methods</span>
<span class="sd">in this module. Both the algorithms use the scipy.optimize methods</span>
<span class="sd">to minimise the fidelity error with respect to to variables that define</span>
<span class="sd">the pulse.</span>

<span class="sd">GRAPE</span>
<span class="sd">-----</span>
<span class="sd">The default algorithm (as it was implemented here first) is GRAPE</span>
<span class="sd">GRadient Ascent Pulse Engineering [1][2]. It uses a gradient based method such</span>
<span class="sd">as BFGS to minimise the fidelity error. This makes convergence very quick</span>
<span class="sd">when an exact gradient can be calculated, but this limits the factors that can</span>
<span class="sd">taken into account in the fidelity.</span>

<span class="sd">CRAB</span>
<span class="sd">----</span>
<span class="sd">The CRAB [3][4] algorithm was developed at the University of Ulm.</span>
<span class="sd">In full it is the Chopped RAndom Basis algorithm.</span>
<span class="sd">The main difference is that it reduces the number of optimisation variables </span>
<span class="sd">by defining the control pulses by expansions of basis functions, </span>
<span class="sd">where the variables are the coefficients. Typically a Fourier series is chosen, </span>
<span class="sd">i.e. the variables are the Fourier coefficients. </span>
<span class="sd">Therefore it does not need to compute an explicit gradient. </span>
<span class="sd">By default it uses the Nelder-Mead method for fidelity error minimisation. </span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">1.  N Khaneja et. al. </span>
<span class="sd">    Optimal control of coupled spin dynamics: Design of NMR pulse sequences </span>
<span class="sd">    by gradient ascent algorithms. J. Magn. Reson. 172, 296–305 (2005).</span>
<span class="sd">2.  Shai Machnes et.al</span>
<span class="sd">    DYNAMO - Dynamic Framework for Quantum Optimal Control</span>
<span class="sd">    arXiv.1011.4874</span>
<span class="sd">3.  Doria, P., Calarco, T. &amp; Montangero, S. </span>
<span class="sd">    Optimal Control Technique for Many-Body Quantum Dynamics. </span>
<span class="sd">    Phys. Rev. Lett. 106, 1–4 (2011).</span>
<span class="sd">4.  Caneva, T., Calarco, T. &amp; Montangero, S. </span>
<span class="sd">    Chopped random-basis quantum optimization. </span>
<span class="sd">    Phys. Rev. A - At. Mol. Opt. Phys. 84, (2011).</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># QuTiP</span>
<span class="kn">from</span> <span class="nn">qutip</span> <span class="k">import</span> <span class="n">Qobj</span>
<span class="kn">import</span> <span class="nn">qutip.logging_utils</span> <span class="k">as</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<span class="c1"># QuTiP control modules</span>
<span class="kn">import</span> <span class="nn">qutip.control.optimconfig</span> <span class="k">as</span> <span class="nn">optimconfig</span>
<span class="kn">import</span> <span class="nn">qutip.control.dynamics</span> <span class="k">as</span> <span class="nn">dynamics</span>
<span class="kn">import</span> <span class="nn">qutip.control.termcond</span> <span class="k">as</span> <span class="nn">termcond</span>
<span class="kn">import</span> <span class="nn">qutip.control.optimizer</span> <span class="k">as</span> <span class="nn">optimizer</span>
<span class="kn">import</span> <span class="nn">qutip.control.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">qutip.control.errors</span> <span class="k">as</span> <span class="nn">errors</span>
<span class="kn">import</span> <span class="nn">qutip.control.fidcomp</span> <span class="k">as</span> <span class="nn">fidcomp</span>
<span class="kn">import</span> <span class="nn">qutip.control.propcomp</span> <span class="k">as</span> <span class="nn">propcomp</span>
<span class="kn">import</span> <span class="nn">qutip.control.pulsegen</span> <span class="k">as</span> <span class="nn">pulsegen</span>
<span class="c1">#import qutip.control.pulsegencrab as pulsegencrab</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span> <span class="c1">#turn off filter </span>
<span class="k">def</span> <span class="nf">_param_deprecation</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Issue deprecation warning</span>
<span class="sd">    Using stacklevel=3 will ensure message refers the function</span>
<span class="sd">    calling with the deprecated parameter,</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">_upper_safe</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">s</span>
            
<div class="viewcode-block" id="optimize_pulse"><a class="viewcode-back" href="../../../apidoc/functions.html#qutip.control.pulseoptim.optimize_pulse">[docs]</a><span class="k">def</span> <span class="nf">optimize_pulse</span><span class="p">(</span>
        <span class="n">drift</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
        <span class="n">num_tslots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evo_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">amp_lbound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amp_ubound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fid_err_targ</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">min_grad</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_wall_time</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
        <span class="n">alg</span><span class="o">=</span><span class="s1">&#39;GRAPE&#39;</span><span class="p">,</span> <span class="n">alg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">optim_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optim_method</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">method_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">optim_alg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_metric_corr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dyn_type</span><span class="o">=</span><span class="s1">&#39;GEN_MAT&#39;</span><span class="p">,</span> <span class="n">dyn_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prop_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">prop_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fid_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">fid_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">phase_option</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fid_err_scale_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tslot_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">tslot_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">amp_update_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">init_pulse_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">init_pulse_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pulse_scaling</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pulse_offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">ramping_pulse_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ramping_pulse_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">,</span> <span class="n">out_file_ext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gen_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimise a control pulse to minimise the fidelity error.</span>
<span class="sd">    The dynamics of the system in any given timeslot are governed</span>
<span class="sd">    by the combined dynamics generator,</span>
<span class="sd">    i.e. the sum of the drift+ctrl_amp[j]*ctrls[j]</span>
<span class="sd">    The control pulse is an [n_ts, n_ctrls)] array of piecewise amplitudes</span>
<span class="sd">    Starting from an intital (typically random) pulse,</span>
<span class="sd">    a multivariable optimisation algorithm attempts to determines the</span>
<span class="sd">    optimal values for the control pulse to minimise the fidelity error</span>
<span class="sd">    The fidelity error is some measure of distance of the system evolution</span>
<span class="sd">    from the given target evolution in the time allowed for the evolution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    drift : Qobj or list of Qobj</span>
<span class="sd">        the underlying dynamics generator of the system</span>
<span class="sd">        can provide list (of length num_tslots) for time dependent drift</span>

<span class="sd">    ctrls : List of Qobj or array like [num_tslots, evo_time]</span>
<span class="sd">        a list of control dynamics generators. These are scaled by</span>
<span class="sd">        the amplitudes to alter the overall dynamics</span>
<span class="sd">        Array like imput can be provided for time dependent control generators</span>

<span class="sd">    initial : Qobj</span>
<span class="sd">        starting point for the evolution.</span>
<span class="sd">        Typically the identity matrix</span>

<span class="sd">    target : Qobj</span>
<span class="sd">        target transformation, e.g. gate or state, for the time evolution</span>

<span class="sd">    num_tslots : integer or None</span>
<span class="sd">        number of timeslots.</span>
<span class="sd">        None implies that timeslots will be given in the tau array</span>

<span class="sd">    evo_time : float or None</span>
<span class="sd">        total time for the evolution</span>
<span class="sd">        None implies that timeslots will be given in the tau array</span>

<span class="sd">    tau : array[num_tslots] of floats or None</span>
<span class="sd">        durations for the timeslots.</span>
<span class="sd">        if this is given then num_tslots and evo_time are dervived</span>
<span class="sd">        from it</span>
<span class="sd">        None implies that timeslot durations will be equal and</span>
<span class="sd">        calculated as evo_time/num_tslots</span>

<span class="sd">    amp_lbound : float or list of floats</span>
<span class="sd">        lower boundaries for the control amplitudes</span>
<span class="sd">        Can be a scalar value applied to all controls</span>
<span class="sd">        or a list of bounds for each control</span>

<span class="sd">    amp_ubound : float or list of floats</span>
<span class="sd">        upper boundaries for the control amplitudes</span>
<span class="sd">        Can be a scalar value applied to all controls</span>
<span class="sd">        or a list of bounds for each control</span>

<span class="sd">    fid_err_targ : float</span>
<span class="sd">        Fidelity error target. Pulse optimisation will</span>
<span class="sd">        terminate when the fidelity error falls below this value</span>

<span class="sd">    mim_grad : float</span>
<span class="sd">        Minimum gradient. When the sum of the squares of the</span>
<span class="sd">        gradients wrt to the control amplitudes falls below this</span>
<span class="sd">        value, the optimisation terminates, assuming local minima</span>

<span class="sd">    max_iter : integer</span>
<span class="sd">        Maximum number of iterations of the optimisation algorithm</span>

<span class="sd">    max_wall_time : float</span>
<span class="sd">        Maximum allowed elapsed time for the  optimisation algorithm</span>

<span class="sd">    alg : string</span>
<span class="sd">        Algorithm to use in pulse optimisation.</span>
<span class="sd">        Options are:</span>
<span class="sd">            </span>
<span class="sd">            &#39;GRAPE&#39; (default) - GRadient Ascent Pulse Engineering</span>
<span class="sd">            &#39;CRAB&#39; - Chopped RAndom Basis</span>

<span class="sd">    alg_params : Dictionary</span>
<span class="sd">        options that are specific to the algorithm see above</span>
<span class="sd">        </span>
<span class="sd">    optim_params : Dictionary</span>
<span class="sd">        The key value pairs are the attribute name and value</span>
<span class="sd">        used to set attribute values</span>
<span class="sd">        Note: attributes are created if they do not exist already,</span>
<span class="sd">        and are overwritten if they do.</span>
<span class="sd">        Note: method_params are applied afterwards and so may override these</span>
<span class="sd">        </span>
<span class="sd">    optim_method : string</span>
<span class="sd">        a scipy.optimize.minimize method that will be used to optimise</span>
<span class="sd">        the pulse for minimum fidelity error</span>
<span class="sd">        Note that FMIN, FMIN_BFGS &amp; FMIN_L_BFGS_B will all result</span>
<span class="sd">        in calling these specific scipy.optimize methods</span>
<span class="sd">        Note the LBFGSB is equivalent to FMIN_L_BFGS_B for backwards </span>
<span class="sd">        capatibility reasons.</span>
<span class="sd">        Supplying DEF will given alg dependent result:</span>
<span class="sd">            GRAPE - Default optim_method is FMIN_L_BFGS_B</span>
<span class="sd">            CRAB - Default optim_method is FMIN</span>
<span class="sd">        </span>
<span class="sd">    method_params : dict</span>
<span class="sd">        Parameters for the optim_method. </span>
<span class="sd">        Note that where there is an attribute of the</span>
<span class="sd">        Optimizer object or the termination_conditions matching the key </span>
<span class="sd">        that attribute. Otherwise, and in some case also, </span>
<span class="sd">        they are assumed to be method_options</span>
<span class="sd">        for the scipy.optimize.minimize method.        </span>
<span class="sd">        </span>
<span class="sd">    optim_alg : string</span>
<span class="sd">        Deprecated. Use optim_method.</span>

<span class="sd">    max_metric_corr : integer</span>
<span class="sd">        Deprecated. Use method_params instead</span>

<span class="sd">    accuracy_factor : float</span>
<span class="sd">        Deprecated. Use method_params instead</span>

<span class="sd">    dyn_type : string</span>
<span class="sd">        Dynamics type, i.e. the type of matrix used to describe</span>
<span class="sd">        the dynamics. Options are UNIT, GEN_MAT, SYMPL</span>
<span class="sd">        (see Dynamics classes for details)</span>
<span class="sd">        </span>
<span class="sd">    dyn_params : dict</span>
<span class="sd">        Parameters for the Dynamics object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    prop_type : string</span>
<span class="sd">        Propagator type i.e. the method used to calculate the</span>
<span class="sd">        propagtors and propagtor gradient for each timeslot</span>
<span class="sd">        options are DEF, APPROX, DIAG, FRECHET, AUG_MAT</span>
<span class="sd">        DEF will use the default for the specific dyn_type</span>
<span class="sd">        (see PropagatorComputer classes for details)</span>

<span class="sd">    prop_params : dict</span>
<span class="sd">        Parameters for the PropagatorComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    fid_type : string</span>
<span class="sd">        Fidelity error (and fidelity error gradient) computation method</span>
<span class="sd">        Options are DEF, UNIT, TRACEDIFF, TD_APPROX</span>
<span class="sd">        DEF will use the default for the specific dyn_type</span>
<span class="sd">        (See FidelityComputer classes for details)</span>

<span class="sd">    fid_params : dict</span>
<span class="sd">        Parameters for the FidelityComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    phase_option : string</span>
<span class="sd">        Deprecated. Pass in fid_params instead.</span>

<span class="sd">    fid_err_scale_factor : float</span>
<span class="sd">        Deprecated. Use scale_factor key in fid_params instead.</span>

<span class="sd">    tslot_type : string</span>
<span class="sd">        Method for computing the dynamics generators, propagators and </span>
<span class="sd">        evolution in the timeslots.</span>
<span class="sd">        Options: DEF, UPDATE_ALL, DYNAMIC</span>
<span class="sd">        UPDATE_ALL is the only one that currently works</span>
<span class="sd">        (See TimeslotComputer classes for details)</span>
<span class="sd">        </span>
<span class="sd">    tslot_params : dict</span>
<span class="sd">        Parameters for the TimeslotComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    amp_update_mode : string</span>
<span class="sd">        Deprecated. Use tslot_type instead.</span>
<span class="sd">        </span>
<span class="sd">    init_pulse_type : string</span>
<span class="sd">        type / shape of pulse(s) used to initialise the</span>
<span class="sd">        the control amplitudes. </span>
<span class="sd">        Options (GRAPE) include:</span>
<span class="sd">            RND, LIN, ZERO, SINE, SQUARE, TRIANGLE, SAW</span>
<span class="sd">        DEF is RND</span>
<span class="sd">        (see PulseGen classes for details)</span>
<span class="sd">        For the CRAB the this the guess_pulse_type. </span>

<span class="sd">    init_pulse_params : dict</span>
<span class="sd">        Parameters for the initial / guess pulse generator object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    pulse_scaling : float</span>
<span class="sd">        Linear scale factor for generated initial / guess pulses</span>
<span class="sd">        By default initial pulses are generated with amplitudes in the</span>
<span class="sd">        range (-1.0, 1.0). These will be scaled by this parameter</span>

<span class="sd">    pulse_offset : float</span>
<span class="sd">        Linear offset for the pulse. That is this value will be added</span>
<span class="sd">        to any initial / guess pulses generated.</span>
<span class="sd">        </span>
<span class="sd">    ramping_pulse_type : string</span>
<span class="sd">        Type of pulse used to modulate the control pulse.</span>
<span class="sd">        It&#39;s intended use for a ramping modulation, which is often required in </span>
<span class="sd">        experimental setups.</span>
<span class="sd">        This is only currently implemented in CRAB.</span>
<span class="sd">        GAUSSIAN_EDGE was added for this purpose.</span>
<span class="sd">        </span>
<span class="sd">    ramping_pulse_params : dict</span>
<span class="sd">        Parameters for the ramping pulse generator object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    log_level : integer</span>
<span class="sd">        level of messaging output from the logger.</span>
<span class="sd">        Options are attributes of qutip.logging_utils,</span>
<span class="sd">        in decreasing levels of messaging, are:</span>
<span class="sd">        DEBUG_INTENSE, DEBUG_VERBOSE, DEBUG, INFO, WARN, ERROR, CRITICAL</span>
<span class="sd">        Anything WARN or above is effectively &#39;quiet&#39; execution,</span>
<span class="sd">        assuming everything runs as expected.</span>
<span class="sd">        The default NOTSET implies that the level will be taken from</span>
<span class="sd">        the QuTiP settings file, which by default is WARN</span>

<span class="sd">    out_file_ext : string or None</span>
<span class="sd">        files containing the initial and final control pulse</span>
<span class="sd">        amplitudes are saved to the current directory.</span>
<span class="sd">        The default name will be postfixed with this extension</span>
<span class="sd">        Setting this to None will suppress the output of files</span>

<span class="sd">    gen_stats : boolean</span>
<span class="sd">        if set to True then statistics for the optimisation</span>
<span class="sd">        run will be generated - accessible through attributes</span>
<span class="sd">        of the stats object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    opt : OptimResult     </span>
<span class="sd">        Returns instance of OptimResult, which has attributes giving the</span>
<span class="sd">        reason for termination, final fidelity error, final evolution</span>
<span class="sd">        final amplitudes, statistics etc</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">log_level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">:</span>
        <span class="n">log_level</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
        
    <span class="c1"># The parameters types are checked in create_pulse_optimizer</span>
    <span class="c1"># so no need to do so here</span>
    <span class="c1"># However, the deprecation management is repeated here</span>
    <span class="c1"># so that the stack level is correct</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">optim_alg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">optim_method</span> <span class="o">=</span> <span class="n">optim_alg</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;optim_alg&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;optim_method&#39; instead&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">max_metric_corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;max_metric_corr&#39;</span> <span class="ow">in</span> <span class="n">method_params</span><span class="p">:</span>
                 <span class="n">method_params</span><span class="p">[</span><span class="s1">&#39;max_metric_corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_metric_corr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;max_metric_corr&#39;</span><span class="p">:</span><span class="n">max_metric_corr</span><span class="p">}</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;max_metric_corr&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;max_metric_corr&#39; in method_params instead&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">accuracy_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;accuracy_factor&#39;</span> <span class="ow">in</span> <span class="n">method_params</span><span class="p">:</span>
                 <span class="n">method_params</span><span class="p">[</span><span class="s1">&#39;accuracy_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accuracy_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accuracy_factor&#39;</span><span class="p">:</span><span class="n">accuracy_factor</span><span class="p">}</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;accuracy_factor&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;accuracy_factor&#39; in method_params instead&quot;</span><span class="p">)</span>
    
    <span class="c1"># phase_option</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">phase_option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fid_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;phase_option&#39;</span> <span class="ow">in</span> <span class="n">fid_params</span><span class="p">:</span>
                 <span class="n">fid_params</span><span class="p">[</span><span class="s1">&#39;phase_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_option</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fid_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;phase_option&#39;</span><span class="p">:</span><span class="n">phase_option</span><span class="p">}</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;phase_option&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;phase_option&#39; in fid_params instead&quot;</span><span class="p">)</span>
            
    <span class="c1"># fid_err_scale_factor</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fid_err_scale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fid_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;fid_err_scale_factor&#39;</span> <span class="ow">in</span> <span class="n">fid_params</span><span class="p">:</span>
                 <span class="n">fid_params</span><span class="p">[</span><span class="s1">&#39;scale_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fid_err_scale_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fid_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale_factor&#39;</span><span class="p">:</span><span class="n">fid_err_scale_factor</span><span class="p">}</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;fid_err_scale_factor&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;scale_factor&#39; in fid_params instead&quot;</span><span class="p">)</span>
            
    <span class="c1"># amp_update_mode</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">amp_update_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">amp_update_mode_up</span> <span class="o">=</span> <span class="n">_upper_safe</span><span class="p">(</span><span class="n">amp_update_mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">amp_update_mode_up</span> <span class="o">==</span> <span class="s1">&#39;ALL&#39;</span><span class="p">:</span>
            <span class="n">tslot_type</span> <span class="o">=</span> <span class="s1">&#39;UPDATE_ALL&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tslot_type</span> <span class="o">=</span> <span class="n">amp_update_mode</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;amp_update_mode&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;tslot_type&#39; instead&quot;</span><span class="p">)</span>

    <span class="n">optim</span> <span class="o">=</span> <span class="n">create_pulse_optimizer</span><span class="p">(</span>
        <span class="n">drift</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
        <span class="n">num_tslots</span><span class="o">=</span><span class="n">num_tslots</span><span class="p">,</span> <span class="n">evo_time</span><span class="o">=</span><span class="n">evo_time</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
        <span class="n">amp_lbound</span><span class="o">=</span><span class="n">amp_lbound</span><span class="p">,</span> <span class="n">amp_ubound</span><span class="o">=</span><span class="n">amp_ubound</span><span class="p">,</span>
        <span class="n">fid_err_targ</span><span class="o">=</span><span class="n">fid_err_targ</span><span class="p">,</span> <span class="n">min_grad</span><span class="o">=</span><span class="n">min_grad</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">max_wall_time</span><span class="o">=</span><span class="n">max_wall_time</span><span class="p">,</span>
        <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span> <span class="n">alg_params</span><span class="o">=</span><span class="n">alg_params</span><span class="p">,</span> <span class="n">optim_params</span><span class="o">=</span><span class="n">optim_params</span><span class="p">,</span>
        <span class="n">optim_method</span><span class="o">=</span><span class="n">optim_method</span><span class="p">,</span> <span class="n">method_params</span><span class="o">=</span><span class="n">method_params</span><span class="p">,</span>
        <span class="n">dyn_type</span><span class="o">=</span><span class="n">dyn_type</span><span class="p">,</span> <span class="n">dyn_params</span><span class="o">=</span><span class="n">dyn_params</span><span class="p">,</span> 
        <span class="n">prop_type</span><span class="o">=</span><span class="n">prop_type</span><span class="p">,</span> <span class="n">prop_params</span><span class="o">=</span><span class="n">prop_params</span><span class="p">,</span>
        <span class="n">fid_type</span><span class="o">=</span><span class="n">fid_type</span><span class="p">,</span> <span class="n">fid_params</span><span class="o">=</span><span class="n">fid_params</span><span class="p">,</span>
        <span class="n">init_pulse_type</span><span class="o">=</span><span class="n">init_pulse_type</span><span class="p">,</span> <span class="n">init_pulse_params</span><span class="o">=</span><span class="n">init_pulse_params</span><span class="p">,</span>
        <span class="n">pulse_scaling</span><span class="o">=</span><span class="n">pulse_scaling</span><span class="p">,</span> <span class="n">pulse_offset</span><span class="o">=</span><span class="n">pulse_offset</span><span class="p">,</span>
        <span class="n">ramping_pulse_type</span><span class="o">=</span><span class="n">ramping_pulse_type</span><span class="p">,</span> 
        <span class="n">ramping_pulse_params</span><span class="o">=</span><span class="n">ramping_pulse_params</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span> <span class="n">gen_stats</span><span class="o">=</span><span class="n">gen_stats</span><span class="p">)</span>

    <span class="n">dyn</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">dynamics</span>

    <span class="n">dyn</span><span class="o">.</span><span class="n">init_timeslots</span><span class="p">()</span>
    <span class="c1"># Generate initial pulses for each control</span>
    <span class="n">init_amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dyn</span><span class="o">.</span><span class="n">num_tslots</span><span class="p">,</span> <span class="n">dyn</span><span class="o">.</span><span class="n">num_ctrls</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;CRAB&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">num_ctrls</span><span class="p">):</span>
            <span class="n">pgen</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">pulse_generator</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">pgen</span><span class="o">.</span><span class="n">init_pulse</span><span class="p">()</span>
            <span class="n">init_amps</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgen</span><span class="o">.</span><span class="n">gen_pulse</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pgen</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">pulse_generator</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">num_ctrls</span><span class="p">):</span>
            <span class="n">init_amps</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgen</span><span class="o">.</span><span class="n">gen_pulse</span><span class="p">()</span>
        
    <span class="c1"># Initialise the starting amplitudes</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">initialize_controls</span><span class="p">(</span><span class="n">init_amps</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">log_level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;System configuration:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">dg_name</span> <span class="o">=</span> <span class="s2">&quot;dynamics generator&quot;</span>
        <span class="k">if</span> <span class="n">dyn_type</span> <span class="o">==</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">:</span>
            <span class="n">dg_name</span> <span class="o">=</span> <span class="s2">&quot;Hamiltonian&quot;</span>
        <span class="k">if</span> <span class="n">dyn</span><span class="o">.</span><span class="n">time_depend_drift</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Initial drift </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dg_name</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">drift_dyn_gen</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Drift </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dg_name</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">drift_dyn_gen</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">num_ctrls</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Control </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dg_name</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initial state / operator:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">initial</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Target state / operator:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out_file_ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Save initial amplitudes to a text file</span>
        <span class="n">pulsefile</span> <span class="o">=</span> <span class="s2">&quot;ctrl_amps_initial_&quot;</span> <span class="o">+</span> <span class="n">out_file_ext</span>
        <span class="n">dyn</span><span class="o">.</span><span class="n">save_amps</span><span class="p">(</span><span class="n">pulsefile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initial amplitudes output to file: &quot;</span> <span class="o">+</span> <span class="n">pulsefile</span><span class="p">)</span>

    <span class="c1"># Start the optimisation</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">run_optimization</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">out_file_ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Save final amplitudes to a text file</span>
        <span class="n">pulsefile</span> <span class="o">=</span> <span class="s2">&quot;ctrl_amps_final_&quot;</span> <span class="o">+</span> <span class="n">out_file_ext</span>
        <span class="n">dyn</span><span class="o">.</span><span class="n">save_amps</span><span class="p">(</span><span class="n">pulsefile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Final amplitudes output to file: &quot;</span> <span class="o">+</span> <span class="n">pulsefile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="optimize_pulse_unitary"><a class="viewcode-back" href="../../../apidoc/functions.html#qutip.control.pulseoptim.optimize_pulse_unitary">[docs]</a><span class="k">def</span> <span class="nf">optimize_pulse_unitary</span><span class="p">(</span>
        <span class="n">H_d</span><span class="p">,</span> <span class="n">H_c</span><span class="p">,</span> <span class="n">U_0</span><span class="p">,</span> <span class="n">U_targ</span><span class="p">,</span>
        <span class="n">num_tslots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evo_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">amp_lbound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amp_ubound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fid_err_targ</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">min_grad</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_wall_time</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
        <span class="n">alg</span><span class="o">=</span><span class="s1">&#39;GRAPE&#39;</span><span class="p">,</span> <span class="n">alg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">optim_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optim_method</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">method_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">optim_alg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_metric_corr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">phase_option</span><span class="o">=</span><span class="s1">&#39;PSU&#39;</span><span class="p">,</span> 
        <span class="n">dyn_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prop_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fid_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tslot_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">tslot_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">amp_update_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">init_pulse_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">init_pulse_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pulse_scaling</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pulse_offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">ramping_pulse_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ramping_pulse_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">,</span> <span class="n">out_file_ext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gen_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimise a control pulse to minimise the fidelity error, assuming that</span>
<span class="sd">    the dynamics of the system are generated by unitary operators.</span>
<span class="sd">    This function is simply a wrapper for optimize_pulse, where the</span>
<span class="sd">    appropriate options for unitary dynamics are chosen and the parameter</span>
<span class="sd">    names are in the format familiar to unitary dynamics</span>
<span class="sd">    The dynamics of the system  in any given timeslot are governed</span>
<span class="sd">    by the combined Hamiltonian,</span>
<span class="sd">    i.e. the sum of the H_d + ctrl_amp[j]*H_c[j]</span>
<span class="sd">    The control pulse is an [n_ts, n_ctrls] array of piecewise amplitudes</span>
<span class="sd">    Starting from an intital (typically random) pulse,</span>
<span class="sd">    a multivariable optimisation algorithm attempts to determines the</span>
<span class="sd">    optimal values for the control pulse to minimise the fidelity error</span>
<span class="sd">    The maximum fidelity for a unitary system is 1, i.e. when the</span>
<span class="sd">    time evolution resulting from the pulse is equivalent to the target.</span>
<span class="sd">    And therefore the fidelity error is 1 - fidelity</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    H_d : Qobj or list of Qobj</span>
<span class="sd">        Drift (aka system) the underlying Hamiltonian of the system</span>
<span class="sd">        can provide list (of length num_tslots) for time dependent drift</span>
<span class="sd">        </span>
<span class="sd">    H_c : List of Qobj or array like [num_tslots, evo_time]</span>
<span class="sd">        a list of control Hamiltonians. These are scaled by</span>
<span class="sd">        the amplitudes to alter the overall dynamics</span>
<span class="sd">        Array like imput can be provided for time dependent control generators</span>

<span class="sd">    U_0 : Qobj</span>
<span class="sd">        starting point for the evolution.</span>
<span class="sd">        Typically the identity matrix</span>

<span class="sd">    U_targ : Qobj</span>
<span class="sd">        target transformation, e.g. gate or state, for the time evolution</span>

<span class="sd">    num_tslots : integer or None</span>
<span class="sd">        number of timeslots.</span>
<span class="sd">        None implies that timeslots will be given in the tau array</span>

<span class="sd">    evo_time : float or None</span>
<span class="sd">        total time for the evolution</span>
<span class="sd">        None implies that timeslots will be given in the tau array</span>

<span class="sd">    tau : array[num_tslots] of floats or None</span>
<span class="sd">        durations for the timeslots.</span>
<span class="sd">        if this is given then num_tslots and evo_time are dervived</span>
<span class="sd">        from it</span>
<span class="sd">        None implies that timeslot durations will be equal and</span>
<span class="sd">        calculated as evo_time/num_tslots</span>

<span class="sd">    amp_lbound : float or list of floats</span>
<span class="sd">        lower boundaries for the control amplitudes</span>
<span class="sd">        Can be a scalar value applied to all controls</span>
<span class="sd">        or a list of bounds for each control</span>

<span class="sd">    amp_ubound : float or list of floats</span>
<span class="sd">        upper boundaries for the control amplitudes</span>
<span class="sd">        Can be a scalar value applied to all controls</span>
<span class="sd">        or a list of bounds for each control</span>

<span class="sd">    fid_err_targ : float</span>
<span class="sd">        Fidelity error target. Pulse optimisation will</span>
<span class="sd">        terminate when the fidelity error falls below this value</span>

<span class="sd">    mim_grad : float</span>
<span class="sd">        Minimum gradient. When the sum of the squares of the</span>
<span class="sd">        gradients wrt to the control amplitudes falls below this</span>
<span class="sd">        value, the optimisation terminates, assuming local minima</span>

<span class="sd">    max_iter : integer</span>
<span class="sd">        Maximum number of iterations of the optimisation algorithm</span>

<span class="sd">    max_wall_time : float</span>
<span class="sd">        Maximum allowed elapsed time for the  optimisation algorithm</span>

<span class="sd">    alg : string</span>
<span class="sd">        Algorithm to use in pulse optimisation.</span>
<span class="sd">        Options are:</span>
<span class="sd">            &#39;GRAPE&#39; (default) - GRadient Ascent Pulse Engineering</span>
<span class="sd">            &#39;CRAB&#39; - Chopped RAndom Basis</span>

<span class="sd">    alg_params : Dictionary</span>
<span class="sd">        options that are specific to the algorithm see above</span>
<span class="sd">        </span>
<span class="sd">    optim_params : Dictionary</span>
<span class="sd">        The key value pairs are the attribute name and value</span>
<span class="sd">        used to set attribute values</span>
<span class="sd">        Note: attributes are created if they do not exist already,</span>
<span class="sd">        and are overwritten if they do.</span>
<span class="sd">        Note: method_params are applied afterwards and so may override these</span>
<span class="sd">        </span>
<span class="sd">    optim_method : string</span>
<span class="sd">        a scipy.optimize.minimize method that will be used to optimise</span>
<span class="sd">        the pulse for minimum fidelity error</span>
<span class="sd">        Note that FMIN, FMIN_BFGS &amp; FMIN_L_BFGS_B will all result</span>
<span class="sd">        in calling these specific scipy.optimize methods</span>
<span class="sd">        Note the LBFGSB is equivalent to FMIN_L_BFGS_B for backwards </span>
<span class="sd">        capatibility reasons.</span>
<span class="sd">        Supplying DEF will given alg dependent result:</span>
<span class="sd">            </span>
<span class="sd">            GRAPE - Default optim_method is FMIN_L_BFGS_B</span>
<span class="sd">            CRAB - Default optim_method is FMIN</span>
<span class="sd">        </span>
<span class="sd">    method_params : dict</span>
<span class="sd">        Parameters for the optim_method. </span>
<span class="sd">        Note that where there is an attribute of the</span>
<span class="sd">        Optimizer object or the termination_conditions matching the key </span>
<span class="sd">        that attribute. Otherwise, and in some case also, </span>
<span class="sd">        they are assumed to be method_options</span>
<span class="sd">        for the scipy.optimize.minimize method.        </span>
<span class="sd">        </span>
<span class="sd">    optim_alg : string</span>
<span class="sd">        Deprecated. Use optim_method.</span>

<span class="sd">    max_metric_corr : integer</span>
<span class="sd">        Deprecated. Use method_params instead</span>

<span class="sd">    accuracy_factor : float</span>
<span class="sd">        Deprecated. Use method_params instead</span>

<span class="sd">    phase_option : string</span>
<span class="sd">        determines how global phase is treated in fidelity</span>
<span class="sd">        calculations (fid_type=&#39;UNIT&#39; only). Options:</span>
<span class="sd">            </span>
<span class="sd">            PSU - global phase ignored</span>
<span class="sd">            SU - global phase included</span>

<span class="sd">    dyn_params : dict</span>
<span class="sd">        Parameters for the Dynamics object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    prop_params : dict</span>
<span class="sd">        Parameters for the PropagatorComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    fid_params : dict</span>
<span class="sd">        Parameters for the FidelityComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    tslot_type : string</span>
<span class="sd">        Method for computing the dynamics generators, propagators and </span>
<span class="sd">        evolution in the timeslots.</span>
<span class="sd">        Options: DEF, UPDATE_ALL, DYNAMIC</span>
<span class="sd">        UPDATE_ALL is the only one that currently works</span>
<span class="sd">        (See TimeslotComputer classes for details)</span>
<span class="sd">        </span>
<span class="sd">    tslot_params : dict</span>
<span class="sd">        Parameters for the TimeslotComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    amp_update_mode : string</span>
<span class="sd">        Deprecated. Use tslot_type instead.</span>
<span class="sd">        </span>
<span class="sd">    init_pulse_type : string</span>
<span class="sd">        type / shape of pulse(s) used to initialise the</span>
<span class="sd">        the control amplitudes. </span>
<span class="sd">        Options (GRAPE) include:</span>
<span class="sd">            </span>
<span class="sd">            RND, LIN, ZERO, SINE, SQUARE, TRIANGLE, SAW</span>
<span class="sd">            DEF is RND</span>
<span class="sd">        </span>
<span class="sd">        (see PulseGen classes for details)</span>
<span class="sd">        For the CRAB the this the guess_pulse_type. </span>

<span class="sd">    init_pulse_params : dict</span>
<span class="sd">        Parameters for the initial / guess pulse generator object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    pulse_scaling : float</span>
<span class="sd">        Linear scale factor for generated initial / guess pulses</span>
<span class="sd">        By default initial pulses are generated with amplitudes in the</span>
<span class="sd">        range (-1.0, 1.0). These will be scaled by this parameter</span>

<span class="sd">    pulse_offset : float</span>
<span class="sd">        Linear offset for the pulse. That is this value will be added</span>
<span class="sd">        to any initial / guess pulses generated.</span>
<span class="sd">        </span>
<span class="sd">    ramping_pulse_type : string</span>
<span class="sd">        Type of pulse used to modulate the control pulse.</span>
<span class="sd">        It&#39;s intended use for a ramping modulation, which is often required in </span>
<span class="sd">        experimental setups.</span>
<span class="sd">        This is only currently implemented in CRAB.</span>
<span class="sd">        GAUSSIAN_EDGE was added for this purpose.</span>
<span class="sd">        </span>
<span class="sd">    ramping_pulse_params : dict</span>
<span class="sd">        Parameters for the ramping pulse generator object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    log_level : integer</span>
<span class="sd">        level of messaging output from the logger.</span>
<span class="sd">        Options are attributes of qutip.logging_utils,</span>
<span class="sd">        in decreasing levels of messaging, are:</span>
<span class="sd">        DEBUG_INTENSE, DEBUG_VERBOSE, DEBUG, INFO, WARN, ERROR, CRITICAL</span>
<span class="sd">        Anything WARN or above is effectively &#39;quiet&#39; execution,</span>
<span class="sd">        assuming everything runs as expected.</span>
<span class="sd">        The default NOTSET implies that the level will be taken from</span>
<span class="sd">        the QuTiP settings file, which by default is WARN</span>

<span class="sd">    out_file_ext : string or None</span>
<span class="sd">        files containing the initial and final control pulse</span>
<span class="sd">        amplitudes are saved to the current directory.</span>
<span class="sd">        The default name will be postfixed with this extension</span>
<span class="sd">        Setting this to None will suppress the output of files</span>

<span class="sd">    gen_stats : boolean</span>
<span class="sd">        if set to True then statistics for the optimisation</span>
<span class="sd">        run will be generated - accessible through attributes</span>
<span class="sd">        of the stats object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    opt : OptimResult</span>
<span class="sd">        Returns instance of OptimResult, which has attributes giving the</span>
<span class="sd">        reason for termination, final fidelity error, final evolution</span>
<span class="sd">        final amplitudes, statistics etc</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># parameters are checked in create pulse optimiser</span>
        
    <span class="c1"># The deprecation management is repeated here</span>
    <span class="c1"># so that the stack level is correct</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">optim_alg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">optim_method</span> <span class="o">=</span> <span class="n">optim_alg</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;optim_alg&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;optim_method&#39; instead&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">max_metric_corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;max_metric_corr&#39;</span> <span class="ow">in</span> <span class="n">method_params</span><span class="p">:</span>
                 <span class="n">method_params</span><span class="p">[</span><span class="s1">&#39;max_metric_corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_metric_corr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;max_metric_corr&#39;</span><span class="p">:</span><span class="n">max_metric_corr</span><span class="p">}</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;max_metric_corr&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;max_metric_corr&#39; in method_params instead&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">accuracy_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;accuracy_factor&#39;</span> <span class="ow">in</span> <span class="n">method_params</span><span class="p">:</span>
                 <span class="n">method_params</span><span class="p">[</span><span class="s1">&#39;accuracy_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accuracy_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accuracy_factor&#39;</span><span class="p">:</span><span class="n">accuracy_factor</span><span class="p">}</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;accuracy_factor&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;accuracy_factor&#39; in method_params instead&quot;</span><span class="p">)</span>
            
    <span class="c1"># amp_update_mode</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">amp_update_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">amp_update_mode_up</span> <span class="o">=</span> <span class="n">_upper_safe</span><span class="p">(</span><span class="n">amp_update_mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">amp_update_mode_up</span> <span class="o">==</span> <span class="s1">&#39;ALL&#39;</span><span class="p">:</span>
            <span class="n">tslot_type</span> <span class="o">=</span> <span class="s1">&#39;UPDATE_ALL&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tslot_type</span> <span class="o">=</span> <span class="n">amp_update_mode</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;amp_update_mode&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;tslot_type&#39; instead&quot;</span><span class="p">)</span>
            
    <span class="c1"># phase_option is still valid for this method</span>
    <span class="c1"># pass it via the fid_params</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">phase_option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fid_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fid_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;phase_option&#39;</span><span class="p">:</span><span class="n">phase_option</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;phase_option&#39;</span> <span class="ow">in</span> <span class="n">fid_params</span><span class="p">:</span>
                <span class="n">fid_params</span><span class="p">[</span><span class="s1">&#39;phase_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_option</span>
            
            
    <span class="k">return</span> <span class="n">optimize_pulse</span><span class="p">(</span>
            <span class="n">drift</span><span class="o">=</span><span class="n">H_d</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">=</span><span class="n">H_c</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">U_0</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">U_targ</span><span class="p">,</span>
            <span class="n">num_tslots</span><span class="o">=</span><span class="n">num_tslots</span><span class="p">,</span> <span class="n">evo_time</span><span class="o">=</span><span class="n">evo_time</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
            <span class="n">amp_lbound</span><span class="o">=</span><span class="n">amp_lbound</span><span class="p">,</span> <span class="n">amp_ubound</span><span class="o">=</span><span class="n">amp_ubound</span><span class="p">,</span>
            <span class="n">fid_err_targ</span><span class="o">=</span><span class="n">fid_err_targ</span><span class="p">,</span> <span class="n">min_grad</span><span class="o">=</span><span class="n">min_grad</span><span class="p">,</span>
            <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">max_wall_time</span><span class="o">=</span><span class="n">max_wall_time</span><span class="p">,</span>
            <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span> <span class="n">alg_params</span><span class="o">=</span><span class="n">alg_params</span><span class="p">,</span> <span class="n">optim_params</span><span class="o">=</span><span class="n">optim_params</span><span class="p">,</span>
            <span class="n">optim_method</span><span class="o">=</span><span class="n">optim_method</span><span class="p">,</span> <span class="n">method_params</span><span class="o">=</span><span class="n">method_params</span><span class="p">,</span>
            <span class="n">dyn_type</span><span class="o">=</span><span class="s1">&#39;UNIT&#39;</span><span class="p">,</span> <span class="n">dyn_params</span><span class="o">=</span><span class="n">dyn_params</span><span class="p">,</span>
            <span class="n">prop_params</span><span class="o">=</span><span class="n">prop_params</span><span class="p">,</span> <span class="n">fid_params</span><span class="o">=</span><span class="n">fid_params</span><span class="p">,</span>
            <span class="n">init_pulse_type</span><span class="o">=</span><span class="n">init_pulse_type</span><span class="p">,</span> <span class="n">init_pulse_params</span><span class="o">=</span><span class="n">init_pulse_params</span><span class="p">,</span>
            <span class="n">pulse_scaling</span><span class="o">=</span><span class="n">pulse_scaling</span><span class="p">,</span> <span class="n">pulse_offset</span><span class="o">=</span><span class="n">pulse_offset</span><span class="p">,</span>
            <span class="n">ramping_pulse_type</span><span class="o">=</span><span class="n">ramping_pulse_type</span><span class="p">,</span> 
            <span class="n">ramping_pulse_params</span><span class="o">=</span><span class="n">ramping_pulse_params</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span> <span class="n">out_file_ext</span><span class="o">=</span><span class="n">out_file_ext</span><span class="p">,</span>
            <span class="n">gen_stats</span><span class="o">=</span><span class="n">gen_stats</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="opt_pulse_crab"><a class="viewcode-back" href="../../../apidoc/functions.html#qutip.control.pulseoptim.opt_pulse_crab">[docs]</a><span class="k">def</span> <span class="nf">opt_pulse_crab</span><span class="p">(</span>
        <span class="n">drift</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
        <span class="n">num_tslots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evo_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">amp_lbound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amp_ubound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fid_err_targ</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_wall_time</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
        <span class="n">alg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_coeffs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_coeff_scaling</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> 
        <span class="n">optim_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optim_method</span><span class="o">=</span><span class="s1">&#39;fmin&#39;</span><span class="p">,</span> <span class="n">method_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dyn_type</span><span class="o">=</span><span class="s1">&#39;GEN_MAT&#39;</span><span class="p">,</span> <span class="n">dyn_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prop_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">prop_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fid_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">fid_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tslot_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">tslot_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">guess_pulse_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">guess_pulse_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">guess_pulse_scaling</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">guess_pulse_offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">guess_pulse_action</span><span class="o">=</span><span class="s1">&#39;MODULATE&#39;</span><span class="p">,</span> 
        <span class="n">ramping_pulse_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ramping_pulse_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">,</span> <span class="n">out_file_ext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gen_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimise a control pulse to minimise the fidelity error.</span>
<span class="sd">    The dynamics of the system in any given timeslot are governed</span>
<span class="sd">    by the combined dynamics generator,</span>
<span class="sd">    i.e. the sum of the drift+ctrl_amp[j]*ctrls[j]</span>
<span class="sd">    The control pulse is an [n_ts, n_ctrls] array of piecewise amplitudes.</span>
<span class="sd">    The CRAB algorithm uses basis function coefficents as the variables to</span>
<span class="sd">    optimise. It does NOT use any gradient function.</span>
<span class="sd">    A multivariable optimisation algorithm attempts to determines the</span>
<span class="sd">    optimal values for the control pulse to minimise the fidelity error</span>
<span class="sd">    The fidelity error is some measure of distance of the system evolution</span>
<span class="sd">    from the given target evolution in the time allowed for the evolution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    drift : Qobj or list of Qobj</span>
<span class="sd">        the underlying dynamics generator of the system</span>
<span class="sd">        can provide list (of length num_tslots) for time dependent drift</span>

<span class="sd">    ctrls : List of Qobj or array like [num_tslots, evo_time]</span>
<span class="sd">        a list of control dynamics generators. These are scaled by</span>
<span class="sd">        the amplitudes to alter the overall dynamics</span>
<span class="sd">        Array like imput can be provided for time dependent control generators</span>

<span class="sd">    initial : Qobj</span>
<span class="sd">        starting point for the evolution.</span>
<span class="sd">        Typically the identity matrix</span>

<span class="sd">    target : Qobj</span>
<span class="sd">        target transformation, e.g. gate or state, for the time evolution</span>

<span class="sd">    num_tslots : integer or None</span>
<span class="sd">        number of timeslots.</span>
<span class="sd">        None implies that timeslots will be given in the tau array</span>

<span class="sd">    evo_time : float or None</span>
<span class="sd">        total time for the evolution</span>
<span class="sd">        None implies that timeslots will be given in the tau array</span>

<span class="sd">    tau : array[num_tslots] of floats or None</span>
<span class="sd">        durations for the timeslots.</span>
<span class="sd">        if this is given then num_tslots and evo_time are dervived</span>
<span class="sd">        from it</span>
<span class="sd">        None implies that timeslot durations will be equal and</span>
<span class="sd">        calculated as evo_time/num_tslots</span>

<span class="sd">    amp_lbound : float or list of floats</span>
<span class="sd">        lower boundaries for the control amplitudes</span>
<span class="sd">        Can be a scalar value applied to all controls</span>
<span class="sd">        or a list of bounds for each control</span>

<span class="sd">    amp_ubound : float or list of floats</span>
<span class="sd">        upper boundaries for the control amplitudes</span>
<span class="sd">        Can be a scalar value applied to all controls</span>
<span class="sd">        or a list of bounds for each control</span>

<span class="sd">    fid_err_targ : float</span>
<span class="sd">        Fidelity error target. Pulse optimisation will</span>
<span class="sd">        terminate when the fidelity error falls below this value</span>

<span class="sd">    max_iter : integer</span>
<span class="sd">        Maximum number of iterations of the optimisation algorithm</span>

<span class="sd">    max_wall_time : float</span>
<span class="sd">        Maximum allowed elapsed time for the  optimisation algorithm</span>

<span class="sd">    alg_params : Dictionary</span>
<span class="sd">        options that are specific to the algorithm see above</span>
<span class="sd">        </span>
<span class="sd">    optim_params : Dictionary</span>
<span class="sd">        The key value pairs are the attribute name and value</span>
<span class="sd">        used to set attribute values</span>
<span class="sd">        Note: attributes are created if they do not exist already,</span>
<span class="sd">        and are overwritten if they do.</span>
<span class="sd">        Note: method_params are applied afterwards and so may override these</span>

<span class="sd">    coeff_scaling : float</span>
<span class="sd">        Linear scale factor for the random basis coefficients</span>
<span class="sd">        By default these range from -1.0 to 1.0</span>
<span class="sd">        Note this is overridden by alg_params (if given there)</span>
<span class="sd">        </span>
<span class="sd">    num_coeffs : integer</span>
<span class="sd">        Number of coefficients used for each basis function</span>
<span class="sd">        Note this is calculated automatically based on the dimension of the</span>
<span class="sd">        dynamics if not given. It is crucial to the performane of the </span>
<span class="sd">        algorithm that it is set as low as possible, while still giving</span>
<span class="sd">        high enough frequencies.</span>
<span class="sd">        Note this is overridden by alg_params (if given there)</span>
<span class="sd">        </span>
<span class="sd">    optim_method : string</span>
<span class="sd">        Multi-variable optimisation method</span>
<span class="sd">        The only tested options are &#39;fmin&#39; and &#39;Nelder-mead&#39;</span>
<span class="sd">        In theory any non-gradient method implemented in </span>
<span class="sd">        scipy.optimize.mininize could be used.</span>

<span class="sd">    method_params : dict</span>
<span class="sd">        Parameters for the optim_method. </span>
<span class="sd">        Note that where there is an attribute of the</span>
<span class="sd">        Optimizer object or the termination_conditions matching the key </span>
<span class="sd">        that attribute. Otherwise, and in some case also, </span>
<span class="sd">        they are assumed to be method_options</span>
<span class="sd">        for the scipy.optimize.minimize method.</span>
<span class="sd">        The commonly used parameter are:</span>
<span class="sd">            xtol - limit on variable change for convergence</span>
<span class="sd">            ftol - limit on fidelity error change for convergence</span>
<span class="sd">            </span>
<span class="sd">    dyn_type : string</span>
<span class="sd">        Dynamics type, i.e. the type of matrix used to describe</span>
<span class="sd">        the dynamics. Options are UNIT, GEN_MAT, SYMPL</span>
<span class="sd">        (see Dynamics classes for details)</span>
<span class="sd">        </span>
<span class="sd">    dyn_params : dict</span>
<span class="sd">        Parameters for the Dynamics object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    prop_type : string</span>
<span class="sd">        Propagator type i.e. the method used to calculate the</span>
<span class="sd">        propagtors and propagtor gradient for each timeslot</span>
<span class="sd">        options are DEF, APPROX, DIAG, FRECHET, AUG_MAT</span>
<span class="sd">        DEF will use the default for the specific dyn_type</span>
<span class="sd">        (see PropagatorComputer classes for details)</span>

<span class="sd">    prop_params : dict</span>
<span class="sd">        Parameters for the PropagatorComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    fid_type : string</span>
<span class="sd">        Fidelity error (and fidelity error gradient) computation method</span>
<span class="sd">        Options are DEF, UNIT, TRACEDIFF, TD_APPROX</span>
<span class="sd">        DEF will use the default for the specific dyn_type</span>
<span class="sd">        (See FidelityComputer classes for details)</span>

<span class="sd">    fid_params : dict</span>
<span class="sd">        Parameters for the FidelityComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    tslot_type : string</span>
<span class="sd">        Method for computing the dynamics generators, propagators and </span>
<span class="sd">        evolution in the timeslots.</span>
<span class="sd">        Options: DEF, UPDATE_ALL, DYNAMIC</span>
<span class="sd">        UPDATE_ALL is the only one that currently works</span>
<span class="sd">        (See TimeslotComputer classes for details)</span>
<span class="sd">        </span>
<span class="sd">    tslot_params : dict</span>
<span class="sd">        Parameters for the TimeslotComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    guess_pulse_type : string</span>
<span class="sd">        type / shape of pulse(s) used modulate the control amplitudes. </span>
<span class="sd">        Options include:</span>
<span class="sd">            RND, LIN, ZERO, SINE, SQUARE, TRIANGLE, SAW, GAUSSIAN</span>
<span class="sd">        Default is None</span>
<span class="sd">        </span>
<span class="sd">    guess_pulse_params : dict</span>
<span class="sd">        Parameters for the guess pulse generator object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    guess_pulse_action : string</span>
<span class="sd">        Determines how the guess pulse is applied to the pulse generated</span>
<span class="sd">        by the basis expansion.</span>
<span class="sd">        Options are: MODULATE, ADD </span>
<span class="sd">        Default is MODULATE</span>

<span class="sd">    pulse_scaling : float</span>
<span class="sd">        Linear scale factor for generated guess pulses</span>
<span class="sd">        By default initial pulses are generated with amplitudes in the</span>
<span class="sd">        range (-1.0, 1.0). These will be scaled by this parameter</span>

<span class="sd">    pulse_offset : float</span>
<span class="sd">        Linear offset for the pulse. That is this value will be added</span>
<span class="sd">        to any guess pulses generated.</span>
<span class="sd">        </span>
<span class="sd">    ramping_pulse_type : string</span>
<span class="sd">        Type of pulse used to modulate the control pulse.</span>
<span class="sd">        It&#39;s intended use for a ramping modulation, which is often required in </span>
<span class="sd">        experimental setups.</span>
<span class="sd">        This is only currently implemented in CRAB.</span>
<span class="sd">        GAUSSIAN_EDGE was added for this purpose.</span>
<span class="sd">        </span>
<span class="sd">    ramping_pulse_params : dict</span>
<span class="sd">        Parameters for the ramping pulse generator object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    log_level : integer</span>
<span class="sd">        level of messaging output from the logger.</span>
<span class="sd">        Options are attributes of qutip.logging_utils,</span>
<span class="sd">        in decreasing levels of messaging, are:</span>
<span class="sd">        DEBUG_INTENSE, DEBUG_VERBOSE, DEBUG, INFO, WARN, ERROR, CRITICAL</span>
<span class="sd">        Anything WARN or above is effectively &#39;quiet&#39; execution,</span>
<span class="sd">        assuming everything runs as expected.</span>
<span class="sd">        The default NOTSET implies that the level will be taken from</span>
<span class="sd">        the QuTiP settings file, which by default is WARN</span>

<span class="sd">    out_file_ext : string or None</span>
<span class="sd">        files containing the initial and final control pulse</span>
<span class="sd">        amplitudes are saved to the current directory.</span>
<span class="sd">        The default name will be postfixed with this extension</span>
<span class="sd">        Setting this to None will suppress the output of files</span>

<span class="sd">    gen_stats : boolean</span>
<span class="sd">        if set to True then statistics for the optimisation</span>
<span class="sd">        run will be generated - accessible through attributes</span>
<span class="sd">        of the stats object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    opt : OptimResult    </span>
<span class="sd">        Returns instance of OptimResult, which has attributes giving the</span>
<span class="sd">        reason for termination, final fidelity error, final evolution</span>
<span class="sd">        final amplitudes, statistics etc</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The parameters are checked in create_pulse_optimizer</span>
    <span class="c1"># so no need to do so here</span>

    <span class="k">if</span> <span class="n">log_level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">:</span>
        <span class="n">log_level</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

    <span class="c1"># build the algorithm options</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alg_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> 
        <span class="n">alg_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;num_coeffs&#39;</span><span class="p">:</span><span class="n">num_coeffs</span><span class="p">,</span> 
                       <span class="s1">&#39;init_coeff_scaling&#39;</span><span class="p">:</span><span class="n">init_coeff_scaling</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_coeffs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="s1">&#39;num_coeffs&#39;</span> <span class="ow">in</span> <span class="n">alg_params</span><span class="p">):</span>
            <span class="n">alg_params</span><span class="p">[</span><span class="s1">&#39;num_coeffs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_coeffs</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">init_coeff_scaling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="s1">&#39;init_coeff_scaling&#39;</span> <span class="ow">in</span> <span class="n">alg_params</span><span class="p">):</span>
            <span class="n">alg_params</span><span class="p">[</span><span class="s1">&#39;init_coeff_scaling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_coeff_scaling</span>
            
    <span class="c1"># Build the guess pulse options</span>
    <span class="c1"># Any options passed in the guess_pulse_params take precedence</span>
    <span class="c1"># over the parameter values.</span>
    <span class="k">if</span> <span class="n">guess_pulse_type</span><span class="p">:</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">guess_pulse_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">guess_pulse_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">guess_pulse_scaling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="s1">&#39;scaling&#39;</span> <span class="ow">in</span> <span class="n">guess_pulse_params</span><span class="p">):</span>
            <span class="n">guess_pulse_params</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess_pulse_scaling</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">guess_pulse_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="s1">&#39;offset&#39;</span> <span class="ow">in</span> <span class="n">guess_pulse_params</span><span class="p">):</span>
            <span class="n">guess_pulse_params</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess_pulse_offset</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">guess_pulse_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="s1">&#39;pulse_action&#39;</span> <span class="ow">in</span> <span class="n">guess_pulse_params</span><span class="p">):</span>
            <span class="n">guess_pulse_params</span><span class="p">[</span><span class="s1">&#39;pulse_action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess_pulse_action</span>
         
    <span class="k">return</span> <span class="n">optimize_pulse</span><span class="p">(</span>
        <span class="n">drift</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
        <span class="n">num_tslots</span><span class="o">=</span><span class="n">num_tslots</span><span class="p">,</span> <span class="n">evo_time</span><span class="o">=</span><span class="n">evo_time</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
        <span class="n">amp_lbound</span><span class="o">=</span><span class="n">amp_lbound</span><span class="p">,</span> <span class="n">amp_ubound</span><span class="o">=</span><span class="n">amp_ubound</span><span class="p">,</span>
        <span class="n">fid_err_targ</span><span class="o">=</span><span class="n">fid_err_targ</span><span class="p">,</span> <span class="n">min_grad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">max_wall_time</span><span class="o">=</span><span class="n">max_wall_time</span><span class="p">,</span>
        <span class="n">alg</span><span class="o">=</span><span class="s1">&#39;CRAB&#39;</span><span class="p">,</span> <span class="n">alg_params</span><span class="o">=</span><span class="n">alg_params</span><span class="p">,</span> <span class="n">optim_params</span><span class="o">=</span><span class="n">optim_params</span><span class="p">,</span>
        <span class="n">optim_method</span><span class="o">=</span><span class="n">optim_method</span><span class="p">,</span> <span class="n">method_params</span><span class="o">=</span><span class="n">method_params</span><span class="p">,</span>
        <span class="n">dyn_type</span><span class="o">=</span><span class="n">dyn_type</span><span class="p">,</span> <span class="n">dyn_params</span><span class="o">=</span><span class="n">dyn_params</span><span class="p">,</span> 
        <span class="n">prop_type</span><span class="o">=</span><span class="n">prop_type</span><span class="p">,</span> <span class="n">prop_params</span><span class="o">=</span><span class="n">prop_params</span><span class="p">,</span>
        <span class="n">fid_type</span><span class="o">=</span><span class="n">fid_type</span><span class="p">,</span> <span class="n">fid_params</span><span class="o">=</span><span class="n">fid_params</span><span class="p">,</span>
        <span class="n">tslot_type</span><span class="o">=</span><span class="n">tslot_type</span><span class="p">,</span> <span class="n">tslot_params</span><span class="o">=</span><span class="n">tslot_params</span><span class="p">,</span>
        <span class="n">init_pulse_type</span><span class="o">=</span><span class="n">guess_pulse_type</span><span class="p">,</span> 
        <span class="n">init_pulse_params</span><span class="o">=</span><span class="n">guess_pulse_params</span><span class="p">,</span>
        <span class="n">ramping_pulse_type</span><span class="o">=</span><span class="n">ramping_pulse_type</span><span class="p">,</span> 
        <span class="n">ramping_pulse_params</span><span class="o">=</span><span class="n">ramping_pulse_params</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span> <span class="n">out_file_ext</span><span class="o">=</span><span class="n">out_file_ext</span><span class="p">,</span> <span class="n">gen_stats</span><span class="o">=</span><span class="n">gen_stats</span><span class="p">)</span></div>
          
<div class="viewcode-block" id="opt_pulse_crab_unitary"><a class="viewcode-back" href="../../../apidoc/functions.html#qutip.control.pulseoptim.opt_pulse_crab_unitary">[docs]</a><span class="k">def</span> <span class="nf">opt_pulse_crab_unitary</span><span class="p">(</span>
        <span class="n">H_d</span><span class="p">,</span> <span class="n">H_c</span><span class="p">,</span> <span class="n">U_0</span><span class="p">,</span> <span class="n">U_targ</span><span class="p">,</span>
        <span class="n">num_tslots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evo_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">amp_lbound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amp_ubound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fid_err_targ</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_wall_time</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
        <span class="n">alg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_coeffs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_coeff_scaling</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> 
        <span class="n">optim_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optim_method</span><span class="o">=</span><span class="s1">&#39;fmin&#39;</span><span class="p">,</span> <span class="n">method_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">phase_option</span><span class="o">=</span><span class="s1">&#39;PSU&#39;</span><span class="p">,</span> 
        <span class="n">dyn_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prop_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fid_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tslot_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">tslot_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">guess_pulse_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">guess_pulse_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">guess_pulse_scaling</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">guess_pulse_offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">guess_pulse_action</span><span class="o">=</span><span class="s1">&#39;MODULATE&#39;</span><span class="p">,</span> 
        <span class="n">ramping_pulse_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ramping_pulse_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">,</span> <span class="n">out_file_ext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gen_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimise a control pulse to minimise the fidelity error, assuming that</span>
<span class="sd">    the dynamics of the system are generated by unitary operators.</span>
<span class="sd">    This function is simply a wrapper for optimize_pulse, where the</span>
<span class="sd">    appropriate options for unitary dynamics are chosen and the parameter</span>
<span class="sd">    names are in the format familiar to unitary dynamics</span>
<span class="sd">    The dynamics of the system  in any given timeslot are governed</span>
<span class="sd">    by the combined Hamiltonian,</span>
<span class="sd">    i.e. the sum of the H_d + ctrl_amp[j]*H_c[j]</span>
<span class="sd">    The control pulse is an [n_ts, n_ctrls] array of piecewise amplitudes</span>
<span class="sd">    </span>
<span class="sd">    The CRAB algorithm uses basis function coefficents as the variables to</span>
<span class="sd">    optimise. It does NOT use any gradient function.</span>
<span class="sd">    A multivariable optimisation algorithm attempts to determines the</span>
<span class="sd">    optimal values for the control pulse to minimise the fidelity error</span>
<span class="sd">    The fidelity error is some measure of distance of the system evolution</span>
<span class="sd">    from the given target evolution in the time allowed for the evolution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    H_d : Qobj or list of Qobj</span>
<span class="sd">        Drift (aka system) the underlying Hamiltonian of the system</span>
<span class="sd">        can provide list (of length num_tslots) for time dependent drift</span>

<span class="sd">    H_c : List of Qobj or array like [num_tslots, evo_time]</span>
<span class="sd">        a list of control Hamiltonians. These are scaled by</span>
<span class="sd">        the amplitudes to alter the overall dynamics</span>
<span class="sd">        Array like imput can be provided for time dependent control generators</span>

<span class="sd">    U_0 : Qobj</span>
<span class="sd">        starting point for the evolution.</span>
<span class="sd">        Typically the identity matrix</span>

<span class="sd">    U_targ : Qobj</span>
<span class="sd">        target transformation, e.g. gate or state, for the time evolution</span>

<span class="sd">    num_tslots : integer or None</span>
<span class="sd">        number of timeslots.</span>
<span class="sd">        None implies that timeslots will be given in the tau array</span>

<span class="sd">    evo_time : float or None</span>
<span class="sd">        total time for the evolution</span>
<span class="sd">        None implies that timeslots will be given in the tau array</span>

<span class="sd">    tau : array[num_tslots] of floats or None</span>
<span class="sd">        durations for the timeslots.</span>
<span class="sd">        if this is given then num_tslots and evo_time are dervived</span>
<span class="sd">        from it</span>
<span class="sd">        None implies that timeslot durations will be equal and</span>
<span class="sd">        calculated as evo_time/num_tslots</span>

<span class="sd">    amp_lbound : float or list of floats</span>
<span class="sd">        lower boundaries for the control amplitudes</span>
<span class="sd">        Can be a scalar value applied to all controls</span>
<span class="sd">        or a list of bounds for each control</span>

<span class="sd">    amp_ubound : float or list of floats</span>
<span class="sd">        upper boundaries for the control amplitudes</span>
<span class="sd">        Can be a scalar value applied to all controls</span>
<span class="sd">        or a list of bounds for each control</span>

<span class="sd">    fid_err_targ : float</span>
<span class="sd">        Fidelity error target. Pulse optimisation will</span>
<span class="sd">        terminate when the fidelity error falls below this value</span>

<span class="sd">    max_iter : integer</span>
<span class="sd">        Maximum number of iterations of the optimisation algorithm</span>

<span class="sd">    max_wall_time : float</span>
<span class="sd">        Maximum allowed elapsed time for the  optimisation algorithm</span>

<span class="sd">    alg_params : Dictionary</span>
<span class="sd">        options that are specific to the algorithm see above</span>
<span class="sd">        </span>
<span class="sd">    optim_params : Dictionary</span>
<span class="sd">        The key value pairs are the attribute name and value</span>
<span class="sd">        used to set attribute values</span>
<span class="sd">        Note: attributes are created if they do not exist already,</span>
<span class="sd">        and are overwritten if they do.</span>
<span class="sd">        Note: method_params are applied afterwards and so may override these</span>

<span class="sd">    coeff_scaling : float</span>
<span class="sd">        Linear scale factor for the random basis coefficients</span>
<span class="sd">        By default these range from -1.0 to 1.0</span>
<span class="sd">        Note this is overridden by alg_params (if given there)</span>
<span class="sd">        </span>
<span class="sd">    num_coeffs : integer</span>
<span class="sd">        Number of coefficients used for each basis function</span>
<span class="sd">        Note this is calculated automatically based on the dimension of the</span>
<span class="sd">        dynamics if not given. It is crucial to the performane of the </span>
<span class="sd">        algorithm that it is set as low as possible, while still giving</span>
<span class="sd">        high enough frequencies.</span>
<span class="sd">        Note this is overridden by alg_params (if given there)</span>
<span class="sd">        </span>
<span class="sd">    optim_method : string</span>
<span class="sd">        Multi-variable optimisation method</span>
<span class="sd">        The only tested options are &#39;fmin&#39; and &#39;Nelder-mead&#39;</span>
<span class="sd">        In theory any non-gradient method implemented in </span>
<span class="sd">        scipy.optimize.mininize could be used.</span>

<span class="sd">    method_params : dict</span>
<span class="sd">        Parameters for the optim_method. </span>
<span class="sd">        Note that where there is an attribute of the</span>
<span class="sd">        Optimizer object or the termination_conditions matching the key </span>
<span class="sd">        that attribute. Otherwise, and in some case also, </span>
<span class="sd">        they are assumed to be method_options</span>
<span class="sd">        for the scipy.optimize.minimize method.</span>
<span class="sd">        The commonly used parameter are:</span>
<span class="sd">            xtol - limit on variable change for convergence</span>
<span class="sd">            ftol - limit on fidelity error change for convergence</span>

<span class="sd">    phase_option : string</span>
<span class="sd">        determines how global phase is treated in fidelity</span>
<span class="sd">        calculations (fid_type=&#39;UNIT&#39; only). Options:</span>
<span class="sd">            PSU - global phase ignored</span>
<span class="sd">            SU - global phase included</span>

<span class="sd">    dyn_params : dict</span>
<span class="sd">        Parameters for the Dynamics object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    prop_params : dict</span>
<span class="sd">        Parameters for the PropagatorComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    fid_params : dict</span>
<span class="sd">        Parameters for the FidelityComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    tslot_type : string</span>
<span class="sd">        Method for computing the dynamics generators, propagators and </span>
<span class="sd">        evolution in the timeslots.</span>
<span class="sd">        Options: DEF, UPDATE_ALL, DYNAMIC</span>
<span class="sd">        UPDATE_ALL is the only one that currently works</span>
<span class="sd">        (See TimeslotComputer classes for details)</span>
<span class="sd">        </span>
<span class="sd">    tslot_params : dict</span>
<span class="sd">        Parameters for the TimeslotComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    guess_pulse_type : string</span>
<span class="sd">        type / shape of pulse(s) used modulate the control amplitudes. </span>
<span class="sd">        Options include:</span>
<span class="sd">            RND, LIN, ZERO, SINE, SQUARE, TRIANGLE, SAW, GAUSSIAN</span>
<span class="sd">        Default is None</span>
<span class="sd">        </span>
<span class="sd">    guess_pulse_params : dict</span>
<span class="sd">        Parameters for the guess pulse generator object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    guess_pulse_action : string</span>
<span class="sd">        Determines how the guess pulse is applied to the pulse generated</span>
<span class="sd">        by the basis expansion.</span>
<span class="sd">        Options are: MODULATE, ADD </span>
<span class="sd">        Default is MODULATE</span>

<span class="sd">    pulse_scaling : float</span>
<span class="sd">        Linear scale factor for generated guess pulses</span>
<span class="sd">        By default initial pulses are generated with amplitudes in the</span>
<span class="sd">        range (-1.0, 1.0). These will be scaled by this parameter</span>

<span class="sd">    pulse_offset : float</span>
<span class="sd">        Linear offset for the pulse. That is this value will be added</span>
<span class="sd">        to any guess pulses generated.</span>
<span class="sd">        </span>
<span class="sd">    ramping_pulse_type : string</span>
<span class="sd">        Type of pulse used to modulate the control pulse.</span>
<span class="sd">        It&#39;s intended use for a ramping modulation, which is often required in </span>
<span class="sd">        experimental setups.</span>
<span class="sd">        This is only currently implemented in CRAB.</span>
<span class="sd">        GAUSSIAN_EDGE was added for this purpose.</span>
<span class="sd">        </span>
<span class="sd">    ramping_pulse_params : dict</span>
<span class="sd">        Parameters for the ramping pulse generator object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    log_level : integer</span>
<span class="sd">        level of messaging output from the logger.</span>
<span class="sd">        Options are attributes of qutip.logging_utils,</span>
<span class="sd">        in decreasing levels of messaging, are:</span>
<span class="sd">        DEBUG_INTENSE, DEBUG_VERBOSE, DEBUG, INFO, WARN, ERROR, CRITICAL</span>
<span class="sd">        Anything WARN or above is effectively &#39;quiet&#39; execution,</span>
<span class="sd">        assuming everything runs as expected.</span>
<span class="sd">        The default NOTSET implies that the level will be taken from</span>
<span class="sd">        the QuTiP settings file, which by default is WARN</span>

<span class="sd">    out_file_ext : string or None</span>
<span class="sd">        files containing the initial and final control pulse</span>
<span class="sd">        amplitudes are saved to the current directory.</span>
<span class="sd">        The default name will be postfixed with this extension</span>
<span class="sd">        Setting this to None will suppress the output of files</span>

<span class="sd">    gen_stats : boolean</span>
<span class="sd">        if set to True then statistics for the optimisation</span>
<span class="sd">        run will be generated - accessible through attributes</span>
<span class="sd">        of the stats object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    opt : OptimResult    </span>
<span class="sd">        Returns instance of OptimResult, which has attributes giving the</span>
<span class="sd">        reason for termination, final fidelity error, final evolution</span>
<span class="sd">        final amplitudes, statistics etc</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The parameters are checked in create_pulse_optimizer</span>
    <span class="c1"># so no need to do so here</span>

    <span class="k">if</span> <span class="n">log_level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">:</span>
        <span class="n">log_level</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

    <span class="c1"># build the algorithm options</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alg_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> 
        <span class="n">alg_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;num_coeffs&#39;</span><span class="p">:</span><span class="n">num_coeffs</span><span class="p">,</span> 
                       <span class="s1">&#39;init_coeff_scaling&#39;</span><span class="p">:</span><span class="n">init_coeff_scaling</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_coeffs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="s1">&#39;num_coeffs&#39;</span> <span class="ow">in</span> <span class="n">alg_params</span><span class="p">):</span>
            <span class="n">alg_params</span><span class="p">[</span><span class="s1">&#39;num_coeffs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_coeffs</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">init_coeff_scaling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="s1">&#39;init_coeff_scaling&#39;</span> <span class="ow">in</span> <span class="n">alg_params</span><span class="p">):</span>
            <span class="n">alg_params</span><span class="p">[</span><span class="s1">&#39;init_coeff_scaling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_coeff_scaling</span>
            
    <span class="c1"># Build the guess pulse options</span>
    <span class="c1"># Any options passed in the guess_pulse_params take precedence</span>
    <span class="c1"># over the parameter values.</span>
    <span class="k">if</span> <span class="n">guess_pulse_type</span><span class="p">:</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">guess_pulse_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">guess_pulse_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">guess_pulse_scaling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="s1">&#39;scaling&#39;</span> <span class="ow">in</span> <span class="n">guess_pulse_params</span><span class="p">):</span>
            <span class="n">guess_pulse_params</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess_pulse_scaling</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">guess_pulse_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="s1">&#39;offset&#39;</span> <span class="ow">in</span> <span class="n">guess_pulse_params</span><span class="p">):</span>
            <span class="n">guess_pulse_params</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess_pulse_offset</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">guess_pulse_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="s1">&#39;pulse_action&#39;</span> <span class="ow">in</span> <span class="n">guess_pulse_params</span><span class="p">):</span>
            <span class="n">guess_pulse_params</span><span class="p">[</span><span class="s1">&#39;pulse_action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess_pulse_action</span>
         
    <span class="k">return</span> <span class="n">optimize_pulse_unitary</span><span class="p">(</span>
        <span class="n">H_d</span><span class="p">,</span> <span class="n">H_c</span><span class="p">,</span> <span class="n">U_0</span><span class="p">,</span> <span class="n">U_targ</span><span class="p">,</span>
        <span class="n">num_tslots</span><span class="o">=</span><span class="n">num_tslots</span><span class="p">,</span> <span class="n">evo_time</span><span class="o">=</span><span class="n">evo_time</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
        <span class="n">amp_lbound</span><span class="o">=</span><span class="n">amp_lbound</span><span class="p">,</span> <span class="n">amp_ubound</span><span class="o">=</span><span class="n">amp_ubound</span><span class="p">,</span>
        <span class="n">fid_err_targ</span><span class="o">=</span><span class="n">fid_err_targ</span><span class="p">,</span> <span class="n">min_grad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">max_wall_time</span><span class="o">=</span><span class="n">max_wall_time</span><span class="p">,</span>
        <span class="n">alg</span><span class="o">=</span><span class="s1">&#39;CRAB&#39;</span><span class="p">,</span> <span class="n">alg_params</span><span class="o">=</span><span class="n">alg_params</span><span class="p">,</span> <span class="n">optim_params</span><span class="o">=</span><span class="n">optim_params</span><span class="p">,</span>
        <span class="n">optim_method</span><span class="o">=</span><span class="n">optim_method</span><span class="p">,</span> <span class="n">method_params</span><span class="o">=</span><span class="n">method_params</span><span class="p">,</span>
        <span class="n">phase_option</span><span class="o">=</span><span class="n">phase_option</span><span class="p">,</span>
        <span class="n">dyn_params</span><span class="o">=</span><span class="n">dyn_params</span><span class="p">,</span> <span class="n">prop_params</span><span class="o">=</span><span class="n">prop_params</span><span class="p">,</span> <span class="n">fid_params</span><span class="o">=</span><span class="n">fid_params</span><span class="p">,</span>
        <span class="n">tslot_type</span><span class="o">=</span><span class="n">tslot_type</span><span class="p">,</span> <span class="n">tslot_params</span><span class="o">=</span><span class="n">tslot_params</span><span class="p">,</span>
        <span class="n">init_pulse_type</span><span class="o">=</span><span class="n">guess_pulse_type</span><span class="p">,</span> 
        <span class="n">init_pulse_params</span><span class="o">=</span><span class="n">guess_pulse_params</span><span class="p">,</span>
        <span class="n">ramping_pulse_type</span><span class="o">=</span><span class="n">ramping_pulse_type</span><span class="p">,</span> 
        <span class="n">ramping_pulse_params</span><span class="o">=</span><span class="n">ramping_pulse_params</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span> <span class="n">out_file_ext</span><span class="o">=</span><span class="n">out_file_ext</span><span class="p">,</span> <span class="n">gen_stats</span><span class="o">=</span><span class="n">gen_stats</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_pulse_optimizer"><a class="viewcode-back" href="../../../apidoc/functions.html#qutip.control.pulseoptim.create_pulse_optimizer">[docs]</a><span class="k">def</span> <span class="nf">create_pulse_optimizer</span><span class="p">(</span>
        <span class="n">drift</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
        <span class="n">num_tslots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evo_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">amp_lbound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amp_ubound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fid_err_targ</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">min_grad</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_wall_time</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
        <span class="n">alg</span><span class="o">=</span><span class="s1">&#39;GRAPE&#39;</span><span class="p">,</span> <span class="n">alg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">optim_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optim_method</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">method_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">optim_alg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_metric_corr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dyn_type</span><span class="o">=</span><span class="s1">&#39;GEN_MAT&#39;</span><span class="p">,</span> <span class="n">dyn_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prop_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">prop_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fid_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">fid_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">phase_option</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fid_err_scale_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tslot_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">tslot_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">amp_update_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">init_pulse_type</span><span class="o">=</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span> <span class="n">init_pulse_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pulse_scaling</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pulse_offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">ramping_pulse_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ramping_pulse_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">,</span> <span class="n">gen_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the objects of the appropriate subclasses</span>
<span class="sd">    required for the pulse optmisation based on the parameters given</span>
<span class="sd">    Note this method may be preferable to calling optimize_pulse</span>
<span class="sd">    if more detailed configuration is required before running the</span>
<span class="sd">    optmisation algorthim, or the algorithm will be run many times,</span>
<span class="sd">    for instances when trying to finding global the optimum or</span>
<span class="sd">    minimum time optimisation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    drift : Qobj or list of Qobj</span>
<span class="sd">        the underlying dynamics generator of the system</span>
<span class="sd">        can provide list (of length num_tslots) for time dependent drift</span>

<span class="sd">    ctrls : List of Qobj or array like [num_tslots, evo_time]</span>
<span class="sd">        a list of control dynamics generators. These are scaled by</span>
<span class="sd">        the amplitudes to alter the overall dynamics</span>
<span class="sd">        Array like imput can be provided for time dependent control generators</span>

<span class="sd">    initial : Qobj</span>
<span class="sd">        starting point for the evolution.</span>
<span class="sd">        Typically the identity matrix</span>

<span class="sd">    target : Qobj</span>
<span class="sd">        target transformation, e.g. gate or state, for the time evolution</span>

<span class="sd">    num_tslots : integer or None</span>
<span class="sd">        number of timeslots.</span>
<span class="sd">        None implies that timeslots will be given in the tau array</span>

<span class="sd">    evo_time : float or None</span>
<span class="sd">        total time for the evolution</span>
<span class="sd">        None implies that timeslots will be given in the tau array</span>

<span class="sd">    tau : array[num_tslots] of floats or None</span>
<span class="sd">        durations for the timeslots.</span>
<span class="sd">        if this is given then num_tslots and evo_time are dervived</span>
<span class="sd">        from it</span>
<span class="sd">        None implies that timeslot durations will be equal and</span>
<span class="sd">        calculated as evo_time/num_tslots</span>

<span class="sd">    amp_lbound : float or list of floats</span>
<span class="sd">        lower boundaries for the control amplitudes</span>
<span class="sd">        Can be a scalar value applied to all controls</span>
<span class="sd">        or a list of bounds for each control</span>

<span class="sd">    amp_ubound : float or list of floats</span>
<span class="sd">        upper boundaries for the control amplitudes</span>
<span class="sd">        Can be a scalar value applied to all controls</span>
<span class="sd">        or a list of bounds for each control</span>

<span class="sd">    fid_err_targ : float</span>
<span class="sd">        Fidelity error target. Pulse optimisation will</span>
<span class="sd">        terminate when the fidelity error falls below this value</span>

<span class="sd">    mim_grad : float</span>
<span class="sd">        Minimum gradient. When the sum of the squares of the</span>
<span class="sd">        gradients wrt to the control amplitudes falls below this</span>
<span class="sd">        value, the optimisation terminates, assuming local minima</span>

<span class="sd">    max_iter : integer</span>
<span class="sd">        Maximum number of iterations of the optimisation algorithm</span>

<span class="sd">    max_wall_time : float</span>
<span class="sd">        Maximum allowed elapsed time for the optimisation algorithm</span>
<span class="sd">        </span>
<span class="sd">    alg : string</span>
<span class="sd">        Algorithm to use in pulse optimisation.</span>
<span class="sd">        Options are:</span>
<span class="sd">            &#39;GRAPE&#39; (default) - GRadient Ascent Pulse Engineering</span>
<span class="sd">            &#39;CRAB&#39; - Chopped RAndom Basis</span>

<span class="sd">    alg_params : Dictionary</span>
<span class="sd">        options that are specific to the algorithm see above</span>
<span class="sd">        </span>
<span class="sd">    optim_params : Dictionary</span>
<span class="sd">        The key value pairs are the attribute name and value</span>
<span class="sd">        used to set attribute values</span>
<span class="sd">        Note: attributes are created if they do not exist already,</span>
<span class="sd">        and are overwritten if they do.</span>
<span class="sd">        Note: method_params are applied afterwards and so may override these</span>
<span class="sd">        </span>
<span class="sd">    optim_method : string</span>
<span class="sd">        a scipy.optimize.minimize method that will be used to optimise</span>
<span class="sd">        the pulse for minimum fidelity error</span>
<span class="sd">        Note that FMIN, FMIN_BFGS &amp; FMIN_L_BFGS_B will all result</span>
<span class="sd">        in calling these specific scipy.optimize methods</span>
<span class="sd">        Note the LBFGSB is equivalent to FMIN_L_BFGS_B for backwards </span>
<span class="sd">        capatibility reasons.</span>
<span class="sd">        Supplying DEF will given alg dependent result:</span>
<span class="sd">            - GRAPE - Default optim_method is FMIN_L_BFGS_B</span>
<span class="sd">            - CRAB - Default optim_method is Nelder-Mead</span>
<span class="sd">        </span>
<span class="sd">    method_params : dict</span>
<span class="sd">        Parameters for the optim_method. </span>
<span class="sd">        Note that where there is an attribute of the</span>
<span class="sd">        Optimizer object or the termination_conditions matching the key </span>
<span class="sd">        that attribute. Otherwise, and in some case also, </span>
<span class="sd">        they are assumed to be method_options</span>
<span class="sd">        for the scipy.optimize.minimize method.        </span>
<span class="sd">        </span>
<span class="sd">    optim_alg : string</span>
<span class="sd">        Deprecated. Use optim_method.</span>

<span class="sd">    max_metric_corr : integer</span>
<span class="sd">        Deprecated. Use method_params instead</span>

<span class="sd">    accuracy_factor : float</span>
<span class="sd">        Deprecated. Use method_params instead</span>

<span class="sd">    dyn_type : string</span>
<span class="sd">        Dynamics type, i.e. the type of matrix used to describe</span>
<span class="sd">        the dynamics. Options are UNIT, GEN_MAT, SYMPL</span>
<span class="sd">        (see Dynamics classes for details)</span>
<span class="sd">        </span>
<span class="sd">    dyn_params : dict</span>
<span class="sd">        Parameters for the Dynamics object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    prop_type : string</span>
<span class="sd">        Propagator type i.e. the method used to calculate the</span>
<span class="sd">        propagtors and propagtor gradient for each timeslot</span>
<span class="sd">        options are DEF, APPROX, DIAG, FRECHET, AUG_MAT</span>
<span class="sd">        DEF will use the default for the specific dyn_type</span>
<span class="sd">        (see PropagatorComputer classes for details)</span>

<span class="sd">    prop_params : dict</span>
<span class="sd">        Parameters for the PropagatorComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    fid_type : string</span>
<span class="sd">        Fidelity error (and fidelity error gradient) computation method</span>
<span class="sd">        Options are DEF, UNIT, TRACEDIFF, TD_APPROX</span>
<span class="sd">        DEF will use the default for the specific dyn_type</span>
<span class="sd">        (See FidelityComputer classes for details)</span>

<span class="sd">    fid_params : dict</span>
<span class="sd">        Parameters for the FidelityComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    phase_option : string</span>
<span class="sd">        Deprecated. Pass in fid_params instead.</span>

<span class="sd">    fid_err_scale_factor : float</span>
<span class="sd">        Deprecated. Use scale_factor key in fid_params instead.</span>

<span class="sd">    tslot_type : string</span>
<span class="sd">        Method for computing the dynamics generators, propagators and </span>
<span class="sd">        evolution in the timeslots.</span>
<span class="sd">        Options: DEF, UPDATE_ALL, DYNAMIC</span>
<span class="sd">        UPDATE_ALL is the only one that currently works</span>
<span class="sd">        (See TimeslotComputer classes for details)</span>
<span class="sd">        </span>
<span class="sd">    tslot_params : dict</span>
<span class="sd">        Parameters for the TimeslotComputer object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">        </span>
<span class="sd">    amp_update_mode : string</span>
<span class="sd">        Deprecated. Use tslot_type instead.</span>
<span class="sd">        </span>
<span class="sd">    init_pulse_type : string</span>
<span class="sd">        type / shape of pulse(s) used to initialise the</span>
<span class="sd">        the control amplitudes. </span>
<span class="sd">        Options (GRAPE) include:</span>
<span class="sd">            </span>
<span class="sd">            RND, LIN, ZERO, SINE, SQUARE, TRIANGLE, SAW</span>
<span class="sd">            DEF is RND</span>
<span class="sd">        </span>
<span class="sd">        (see PulseGen classes for details)</span>
<span class="sd">        For the CRAB the this the guess_pulse_type. </span>

<span class="sd">    init_pulse_params : dict</span>
<span class="sd">        Parameters for the initial / guess pulse generator object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>

<span class="sd">    pulse_scaling : float</span>
<span class="sd">        Linear scale factor for generated initial / guess pulses</span>
<span class="sd">        By default initial pulses are generated with amplitudes in the</span>
<span class="sd">        range (-1.0, 1.0). These will be scaled by this parameter</span>

<span class="sd">    pulse_offset : float</span>
<span class="sd">        Linear offset for the pulse. That is this value will be added</span>
<span class="sd">        to any initial / guess pulses generated.</span>
<span class="sd">        </span>
<span class="sd">    ramping_pulse_type : string</span>
<span class="sd">        Type of pulse used to modulate the control pulse.</span>
<span class="sd">        It&#39;s intended use for a ramping modulation, which is often required in </span>
<span class="sd">        experimental setups.</span>
<span class="sd">        This is only currently implemented in CRAB.</span>
<span class="sd">        GAUSSIAN_EDGE was added for this purpose.</span>
<span class="sd">        </span>
<span class="sd">    ramping_pulse_params : dict</span>
<span class="sd">        Parameters for the ramping pulse generator object</span>
<span class="sd">        The key value pairs are assumed to be attribute name value pairs</span>
<span class="sd">        They applied after the object is created</span>
<span class="sd">    </span>
<span class="sd">    log_level : integer</span>
<span class="sd">        level of messaging output from the logger.</span>
<span class="sd">        Options are attributes of qutip.logging_utils,</span>
<span class="sd">        in decreasing levels of messaging, are:</span>
<span class="sd">        DEBUG_INTENSE, DEBUG_VERBOSE, DEBUG, INFO, WARN, ERROR, CRITICAL</span>
<span class="sd">        Anything WARN or above is effectively &#39;quiet&#39; execution,</span>
<span class="sd">        assuming everything runs as expected.</span>
<span class="sd">        The default NOTSET implies that the level will be taken from</span>
<span class="sd">        the QuTiP settings file, which by default is WARN</span>

<span class="sd">    gen_stats : boolean</span>
<span class="sd">        if set to True then statistics for the optimisation</span>
<span class="sd">        run will be generated - accessible through attributes</span>
<span class="sd">        of the stats object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    opt : Optimizer    </span>
<span class="sd">        Instance of an Optimizer, through which the</span>
<span class="sd">        Config, Dynamics, PulseGen, and TerminationConditions objects</span>
<span class="sd">        can be accessed as attributes.</span>
<span class="sd">        The PropagatorComputer, FidelityComputer and TimeslotComputer objects</span>
<span class="sd">        can be accessed as attributes of the Dynamics object, e.g. optimizer.dynamics.fid_computer</span>
<span class="sd">        The optimisation can be run through the optimizer.run_optimization</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check parameters</span>
    <span class="n">ctrls</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">_check_ctrls_container</span><span class="p">(</span><span class="n">ctrls</span><span class="p">)</span>
    <span class="n">dynamics</span><span class="o">.</span><span class="n">_check_drift_dyn_gen</span><span class="p">(</span><span class="n">drift</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;initial must be a Qobj&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;target must be a Qobj&quot;</span><span class="p">)</span>
        
    <span class="c1"># Deprecated parameter management</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">optim_alg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">optim_method</span> <span class="o">=</span> <span class="n">optim_alg</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;optim_alg&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;optim_method&#39; instead&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">max_metric_corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;max_metric_corr&#39;</span> <span class="ow">in</span> <span class="n">method_params</span><span class="p">:</span>
                 <span class="n">method_params</span><span class="p">[</span><span class="s1">&#39;max_metric_corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_metric_corr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;max_metric_corr&#39;</span><span class="p">:</span><span class="n">max_metric_corr</span><span class="p">}</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;max_metric_corr&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;max_metric_corr&#39; in method_params instead&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">accuracy_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;accuracy_factor&#39;</span> <span class="ow">in</span> <span class="n">method_params</span><span class="p">:</span>
                 <span class="n">method_params</span><span class="p">[</span><span class="s1">&#39;accuracy_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accuracy_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accuracy_factor&#39;</span><span class="p">:</span><span class="n">accuracy_factor</span><span class="p">}</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;accuracy_factor&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;accuracy_factor&#39; in method_params instead&quot;</span><span class="p">)</span>
    
    <span class="c1"># phase_option</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">phase_option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fid_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;phase_option&#39;</span> <span class="ow">in</span> <span class="n">fid_params</span><span class="p">:</span>
                 <span class="n">fid_params</span><span class="p">[</span><span class="s1">&#39;phase_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_option</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fid_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;phase_option&#39;</span><span class="p">:</span><span class="n">phase_option</span><span class="p">}</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;phase_option&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;phase_option&#39; in fid_params instead&quot;</span><span class="p">)</span>
            
    <span class="c1"># fid_err_scale_factor</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fid_err_scale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fid_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;fid_err_scale_factor&#39;</span> <span class="ow">in</span> <span class="n">fid_params</span><span class="p">:</span>
                 <span class="n">fid_params</span><span class="p">[</span><span class="s1">&#39;scale_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fid_err_scale_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fid_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale_factor&#39;</span><span class="p">:</span><span class="n">fid_err_scale_factor</span><span class="p">}</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;fid_err_scale_factor&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;scale_factor&#39; in fid_params instead&quot;</span><span class="p">)</span>
            
    <span class="c1"># amp_update_mode</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">amp_update_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">amp_update_mode_up</span> <span class="o">=</span> <span class="n">_upper_safe</span><span class="p">(</span><span class="n">amp_update_mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">amp_update_mode_up</span> <span class="o">==</span> <span class="s1">&#39;ALL&#39;</span><span class="p">:</span>
            <span class="n">tslot_type</span> <span class="o">=</span> <span class="s1">&#39;UPDATE_ALL&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tslot_type</span> <span class="o">=</span> <span class="n">amp_update_mode</span>
        <span class="n">_param_deprecation</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;amp_update_mode&#39; parameter is deprecated. &quot;</span>
            <span class="s2">&quot;Use &#39;tslot_type&#39; instead&quot;</span><span class="p">)</span>
            
    <span class="c1"># set algorithm defaults</span>
    <span class="n">alg_up</span> <span class="o">=</span> <span class="n">_upper_safe</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
            <span class="s2">&quot;Optimisation algorithm must be specified through &#39;alg&#39; parameter&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">alg_up</span> <span class="o">==</span> <span class="s1">&#39;GRAPE&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">optim_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">optim_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DEF&#39;</span><span class="p">:</span>
            <span class="n">optim_method</span> <span class="o">=</span> <span class="s1">&#39;FMIN_L_BFGS_B&#39;</span>
        <span class="k">if</span> <span class="n">init_pulse_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">init_pulse_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DEF&#39;</span><span class="p">:</span>
            <span class="n">init_pulse_type</span> <span class="o">=</span> <span class="s1">&#39;RND&#39;</span>
    <span class="k">elif</span> <span class="n">alg_up</span> <span class="o">==</span> <span class="s1">&#39;CRAB&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">optim_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">optim_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DEF&#39;</span><span class="p">:</span>
            <span class="n">optim_method</span> <span class="o">=</span> <span class="s1">&#39;FMIN&#39;</span>
        <span class="k">if</span> <span class="n">prop_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">prop_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DEF&#39;</span><span class="p">:</span>
            <span class="n">prop_type</span> <span class="o">=</span> <span class="s1">&#39;APPROX&#39;</span>
        <span class="k">if</span> <span class="n">init_pulse_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">init_pulse_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DEF&#39;</span><span class="p">:</span>
            <span class="n">init_pulse_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
            <span class="s2">&quot;No option for pulse optimisation algorithm alg=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alg</span><span class="p">))</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="n">optimconfig</span><span class="o">.</span><span class="n">OptimConfig</span><span class="p">()</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">optim_method</span> <span class="o">=</span> <span class="n">optim_method</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">dyn_type</span> <span class="o">=</span> <span class="n">dyn_type</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">prop_type</span> <span class="o">=</span> <span class="n">prop_type</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">fid_type</span> <span class="o">=</span> <span class="n">fid_type</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">init_pulse_type</span> <span class="o">=</span> <span class="n">init_pulse_type</span>

    <span class="k">if</span> <span class="n">log_level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">:</span>
        <span class="n">log_level</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

    <span class="n">cfg</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span>

    <span class="c1"># Create the Dynamics instance</span>
    <span class="k">if</span> <span class="n">dyn_type</span> <span class="o">==</span> <span class="s1">&#39;GEN_MAT&#39;</span> <span class="ow">or</span> <span class="n">dyn_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dyn_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">dyn</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">DynamicsGenMat</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dyn_type</span> <span class="o">==</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">:</span>
        <span class="n">dyn</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">DynamicsUnitary</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dyn_type</span> <span class="o">==</span> <span class="s1">&#39;SYMPL&#39;</span><span class="p">:</span>
        <span class="n">dyn</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">DynamicsSymplectic</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s2">&quot;No option for dyn_type: &quot;</span> <span class="o">+</span> <span class="n">dyn_type</span><span class="p">)</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">apply_params</span><span class="p">(</span><span class="n">dyn_params</span><span class="p">)</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">_drift_dyn_gen_checked</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">_ctrl_dyn_gen_checked</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="c1"># Create the PropagatorComputer instance</span>
    <span class="c1"># The default will be typically be the best option</span>
    <span class="k">if</span> <span class="n">prop_type</span> <span class="o">==</span> <span class="s1">&#39;DEF&#39;</span> <span class="ow">or</span> <span class="n">prop_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">prop_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1"># Do nothing use the default for the Dynamics</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">prop_type</span> <span class="o">==</span> <span class="s1">&#39;APPROX&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">prop_computer</span><span class="p">,</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompApproxGrad</span><span class="p">):</span>
            <span class="n">dyn</span><span class="o">.</span><span class="n">prop_computer</span> <span class="o">=</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompApproxGrad</span><span class="p">(</span><span class="n">dyn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">prop_type</span> <span class="o">==</span> <span class="s1">&#39;DIAG&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">prop_computer</span><span class="p">,</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompDiag</span><span class="p">):</span>
            <span class="n">dyn</span><span class="o">.</span><span class="n">prop_computer</span> <span class="o">=</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompDiag</span><span class="p">(</span><span class="n">dyn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">prop_type</span> <span class="o">==</span> <span class="s1">&#39;AUG_MAT&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">prop_computer</span><span class="p">,</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompAugMat</span><span class="p">):</span>
            <span class="n">dyn</span><span class="o">.</span><span class="n">prop_computer</span> <span class="o">=</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompAugMat</span><span class="p">(</span><span class="n">dyn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">prop_type</span> <span class="o">==</span> <span class="s1">&#39;FRECHET&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">prop_computer</span><span class="p">,</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompFrechet</span><span class="p">):</span>
            <span class="n">dyn</span><span class="o">.</span><span class="n">prop_computer</span> <span class="o">=</span> <span class="n">propcomp</span><span class="o">.</span><span class="n">PropCompFrechet</span><span class="p">(</span><span class="n">dyn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s2">&quot;No option for prop_type: &quot;</span> <span class="o">+</span> <span class="n">prop_type</span><span class="p">)</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">prop_computer</span><span class="o">.</span><span class="n">apply_params</span><span class="p">(</span><span class="n">prop_params</span><span class="p">)</span>

    <span class="c1"># Create the FidelityComputer instance</span>
    <span class="c1"># The default will be typically be the best option</span>
    <span class="c1"># Note: the FidCompTraceDiffApprox is a subclass of FidCompTraceDiff</span>
    <span class="c1"># so need to check this type first</span>
    <span class="n">fid_type_up</span> <span class="o">=</span> <span class="n">_upper_safe</span><span class="p">(</span><span class="n">fid_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fid_type_up</span> <span class="o">==</span> <span class="s1">&#39;DEF&#39;</span> <span class="ow">or</span> <span class="n">fid_type_up</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fid_type_up</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1"># None given, use the default for the Dynamics</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">fid_type_up</span> <span class="o">==</span> <span class="s1">&#39;TDAPPROX&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">fid_computer</span><span class="p">,</span> <span class="n">fidcomp</span><span class="o">.</span><span class="n">FidCompTraceDiffApprox</span><span class="p">):</span>
            <span class="n">dyn</span><span class="o">.</span><span class="n">fid_computer</span> <span class="o">=</span> <span class="n">fidcomp</span><span class="o">.</span><span class="n">FidCompTraceDiffApprox</span><span class="p">(</span><span class="n">dyn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fid_type_up</span> <span class="o">==</span> <span class="s1">&#39;TRACEDIFF&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">fid_computer</span><span class="p">,</span> <span class="n">fidcomp</span><span class="o">.</span><span class="n">FidCompTraceDiff</span><span class="p">):</span>
            <span class="n">dyn</span><span class="o">.</span><span class="n">fid_computer</span> <span class="o">=</span> <span class="n">fidcomp</span><span class="o">.</span><span class="n">FidCompTraceDiff</span><span class="p">(</span><span class="n">dyn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fid_type_up</span> <span class="o">==</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dyn</span><span class="o">.</span><span class="n">fid_computer</span><span class="p">,</span> <span class="n">fidcomp</span><span class="o">.</span><span class="n">FidCompUnitary</span><span class="p">):</span>
            <span class="n">dyn</span><span class="o">.</span><span class="n">fid_computer</span> <span class="o">=</span> <span class="n">fidcomp</span><span class="o">.</span><span class="n">FidCompUnitary</span><span class="p">(</span><span class="n">dyn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s2">&quot;No option for fid_type: &quot;</span> <span class="o">+</span> <span class="n">fid_type</span><span class="p">)</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">fid_computer</span><span class="o">.</span><span class="n">apply_params</span><span class="p">(</span><span class="n">fid_params</span><span class="p">)</span>
    
    <span class="c1"># Currently the only working option for tslot computer is </span>
    <span class="c1"># TSlotCompUpdateAll.</span>
    <span class="c1"># so just apply the parameters</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">tslot_computer</span><span class="o">.</span><span class="n">apply_params</span><span class="p">(</span><span class="n">tslot_params</span><span class="p">)</span>    

    <span class="c1"># Create the Optimiser instance</span>
    <span class="n">optim_method_up</span> <span class="o">=</span> <span class="n">_upper_safe</span><span class="p">(</span><span class="n">optim_method</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">optim_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">optim_method_up</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s2">&quot;Optimisation method must be specified &quot;</span>
                                <span class="s2">&quot;via &#39;optim_method&#39; parameter&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">optim_method_up</span> <span class="o">==</span> <span class="s1">&#39;FMIN_BFGS&#39;</span><span class="p">:</span>
        <span class="n">optim</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">OptimizerBFGS</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dyn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">optim_method_up</span> <span class="o">==</span> <span class="s1">&#39;LBFGSB&#39;</span> <span class="ow">or</span> <span class="n">optim_method_up</span> <span class="o">==</span> <span class="s1">&#39;FMIN_L_BFGS_B&#39;</span><span class="p">:</span>
        <span class="n">optim</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">OptimizerLBFGSB</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dyn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">optim_method_up</span> <span class="o">==</span> <span class="s1">&#39;FMIN&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alg_up</span> <span class="o">==</span> <span class="s1">&#39;CRAB&#39;</span><span class="p">:</span>
            <span class="n">optim</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">OptimizerCrabFmin</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dyn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid optim_method &#39;</span><span class="si">{}</span><span class="s2">&#39; for &#39;</span><span class="si">{}</span><span class="s2">&#39; algorthim&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">optim_method</span><span class="p">,</span> <span class="n">alg</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Assume that the optim_method is a valid</span>
        <span class="c1">#scipy.optimize.minimize method</span>
        <span class="c1"># Choose an optimiser based on the algorithm</span>
        <span class="k">if</span> <span class="n">alg_up</span> <span class="o">==</span> <span class="s1">&#39;CRAB&#39;</span><span class="p">:</span>
            <span class="n">optim</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">OptimizerCrab</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dyn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optim</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dyn</span><span class="p">)</span>
    
    <span class="n">optim</span><span class="o">.</span><span class="n">alg</span> <span class="o">=</span> <span class="n">alg</span>
    <span class="n">optim</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">optim_method</span>
    <span class="n">optim</span><span class="o">.</span><span class="n">amp_lbound</span> <span class="o">=</span> <span class="n">amp_lbound</span>
    <span class="n">optim</span><span class="o">.</span><span class="n">amp_ubound</span> <span class="o">=</span> <span class="n">amp_ubound</span>
    <span class="n">optim</span><span class="o">.</span><span class="n">apply_params</span><span class="p">(</span><span class="n">optim_params</span><span class="p">)</span>
    
    <span class="c1"># Create the TerminationConditions instance</span>
    <span class="n">tc</span> <span class="o">=</span> <span class="n">termcond</span><span class="o">.</span><span class="n">TerminationConditions</span><span class="p">()</span>
    <span class="n">tc</span><span class="o">.</span><span class="n">fid_err_targ</span> <span class="o">=</span> <span class="n">fid_err_targ</span>
    <span class="n">tc</span><span class="o">.</span><span class="n">min_gradient_norm</span> <span class="o">=</span> <span class="n">min_grad</span>
    <span class="n">tc</span><span class="o">.</span><span class="n">max_iterations</span> <span class="o">=</span> <span class="n">max_iter</span>
    <span class="n">tc</span><span class="o">.</span><span class="n">max_wall_time</span> <span class="o">=</span> <span class="n">max_wall_time</span>
    <span class="n">optim</span><span class="o">.</span><span class="n">termination_conditions</span> <span class="o">=</span> <span class="n">tc</span>
    
    <span class="n">optim</span><span class="o">.</span><span class="n">apply_method_params</span><span class="p">(</span><span class="n">method_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gen_stats</span><span class="p">:</span>
        <span class="c1"># Create a stats object</span>
        <span class="c1"># Note that stats object is optional</span>
        <span class="c1"># if the Dynamics and Optimizer stats attribute is not set</span>
        <span class="c1"># then no stats will be collected, which could improve performance</span>
        <span class="k">if</span> <span class="n">amp_update_mode</span> <span class="o">==</span> <span class="s1">&#39;DYNAMIC&#39;</span><span class="p">:</span>
            <span class="n">sts</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">StatsDynTsUpdate</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sts</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">Stats</span><span class="p">()</span>

        <span class="n">dyn</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">sts</span>
        <span class="n">optim</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">sts</span>

    <span class="c1"># Configure the dynamics</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">drift_dyn_gen</span> <span class="o">=</span> <span class="n">drift</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">ctrl_dyn_gen</span> <span class="o">=</span> <span class="n">ctrls</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">initial</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
    <span class="k">if</span> <span class="n">tau</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Check that parameters have been supplied to generate the</span>
        <span class="c1"># timeslot durations</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">evo_time</span> <span class="o">/</span> <span class="n">num_tslots</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                <span class="s2">&quot;Either the timeslot durations should be supplied as an &quot;</span>
                <span class="s2">&quot;array &#39;tau&#39; or the number of timeslots &#39;num_tslots&#39; &quot;</span>
                <span class="s2">&quot;and the evolution time &#39;evo_time&#39; must be given.&quot;</span><span class="p">)</span>

        <span class="n">dyn</span><span class="o">.</span><span class="n">num_tslots</span> <span class="o">=</span> <span class="n">num_tslots</span>
        <span class="n">dyn</span><span class="o">.</span><span class="n">evo_time</span> <span class="o">=</span> <span class="n">evo_time</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dyn</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>

    <span class="c1"># this function is called, so that the num_ctrls attribute will be set</span>
    <span class="n">n_ctrls</span> <span class="o">=</span> <span class="n">dyn</span><span class="o">.</span><span class="n">num_ctrls</span>

    <span class="n">ramping_pgen</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">ramping_pulse_type</span><span class="p">:</span>
        <span class="n">ramping_pgen</span> <span class="o">=</span> <span class="n">pulsegen</span><span class="o">.</span><span class="n">create_pulse_gen</span><span class="p">(</span>
                            <span class="n">pulse_type</span><span class="o">=</span><span class="n">ramping_pulse_type</span><span class="p">,</span> <span class="n">dyn</span><span class="o">=</span><span class="n">dyn</span><span class="p">,</span> 
                            <span class="n">pulse_params</span><span class="o">=</span><span class="n">ramping_pulse_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alg_up</span> <span class="o">==</span> <span class="s1">&#39;CRAB&#39;</span><span class="p">:</span>
        <span class="c1"># Create a pulse generator for each ctrl</span>
        <span class="n">crab_pulse_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">num_coeffs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">init_coeff_scaling</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alg_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">num_coeffs</span> <span class="o">=</span> <span class="n">alg_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_coeffs&#39;</span><span class="p">)</span>
            <span class="n">init_coeff_scaling</span> <span class="o">=</span> <span class="n">alg_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;init_coeff_scaling&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;crab_pulse_params&#39;</span> <span class="ow">in</span> <span class="n">alg_params</span><span class="p">:</span>
                <span class="n">crab_pulse_params</span> <span class="o">=</span> <span class="n">alg_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;crab_pulse_params&#39;</span><span class="p">)</span>
            
        <span class="n">guess_pulse_type</span> <span class="o">=</span> <span class="n">init_pulse_type</span>
        <span class="k">if</span> <span class="n">guess_pulse_type</span><span class="p">:</span>
            <span class="n">guess_pulse_action</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">guess_pgen</span> <span class="o">=</span> <span class="n">pulsegen</span><span class="o">.</span><span class="n">create_pulse_gen</span><span class="p">(</span>
                                <span class="n">pulse_type</span><span class="o">=</span><span class="n">guess_pulse_type</span><span class="p">,</span> <span class="n">dyn</span><span class="o">=</span><span class="n">dyn</span><span class="p">)</span>
            <span class="n">guess_pgen</span><span class="o">.</span><span class="n">scaling</span> <span class="o">=</span> <span class="n">pulse_scaling</span>
            <span class="n">guess_pgen</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">pulse_offset</span>
            <span class="k">if</span> <span class="n">init_pulse_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">guess_pgen</span><span class="o">.</span><span class="n">apply_params</span><span class="p">(</span><span class="n">init_pulse_params</span><span class="p">)</span>
                <span class="n">guess_pulse_action</span> <span class="o">=</span> <span class="n">init_pulse_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pulse_action&#39;</span><span class="p">)</span>

        <span class="n">optim</span><span class="o">.</span><span class="n">pulse_generator</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ctrls</span><span class="p">):</span>
            <span class="n">crab_pgen</span> <span class="o">=</span> <span class="n">pulsegen</span><span class="o">.</span><span class="n">PulseGenCrabFourier</span><span class="p">(</span>
                                <span class="n">dyn</span><span class="o">=</span><span class="n">dyn</span><span class="p">,</span> <span class="n">num_coeffs</span><span class="o">=</span><span class="n">num_coeffs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">init_coeff_scaling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">crab_pgen</span><span class="o">.</span><span class="n">scaling</span> <span class="o">=</span> <span class="n">init_coeff_scaling</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crab_pulse_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">crab_pgen</span><span class="o">.</span><span class="n">apply_params</span><span class="p">(</span><span class="n">crab_pulse_params</span><span class="p">)</span>
                
            <span class="n">lb</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">amp_lbound</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">amp_lbound</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lb</span> <span class="o">=</span> <span class="n">amp_lbound</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">lb</span> <span class="o">=</span> <span class="n">amp_lbound</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lb</span> <span class="o">=</span> <span class="n">amp_lbound</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">amp_ubound</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">amp_ubound</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ub</span> <span class="o">=</span> <span class="n">amp_ubound</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">ub</span> <span class="o">=</span> <span class="n">amp_ubound</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ub</span> <span class="o">=</span> <span class="n">amp_ubound</span>
            <span class="n">crab_pgen</span><span class="o">.</span><span class="n">lbound</span> <span class="o">=</span> <span class="n">lb</span>
            <span class="n">crab_pgen</span><span class="o">.</span><span class="n">ubound</span> <span class="o">=</span> <span class="n">ub</span>
            
            <span class="k">if</span> <span class="n">guess_pulse_type</span><span class="p">:</span>
                <span class="n">guess_pgen</span><span class="o">.</span><span class="n">lbound</span> <span class="o">=</span> <span class="n">lb</span>
                <span class="n">guess_pgen</span><span class="o">.</span><span class="n">ubound</span> <span class="o">=</span> <span class="n">ub</span>
                <span class="n">crab_pgen</span><span class="o">.</span><span class="n">guess_pulse</span> <span class="o">=</span> <span class="n">guess_pgen</span><span class="o">.</span><span class="n">gen_pulse</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">guess_pulse_action</span><span class="p">:</span>
                    <span class="n">crab_pgen</span><span class="o">.</span><span class="n">guess_pulse_action</span> <span class="o">=</span> <span class="n">guess_pulse_action</span>
                
            <span class="k">if</span> <span class="n">ramping_pgen</span><span class="p">:</span>
                <span class="n">crab_pgen</span><span class="o">.</span><span class="n">ramping_pulse</span> <span class="o">=</span> <span class="n">ramping_pgen</span><span class="o">.</span><span class="n">gen_pulse</span><span class="p">()</span>

            <span class="n">optim</span><span class="o">.</span><span class="n">pulse_generator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crab_pgen</span><span class="p">)</span>
        <span class="c1">#This is just for the debug message now</span>
        <span class="n">pgen</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">pulse_generator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create a pulse generator of the type specified</span>
        <span class="n">pgen</span> <span class="o">=</span> <span class="n">pulsegen</span><span class="o">.</span><span class="n">create_pulse_gen</span><span class="p">(</span><span class="n">pulse_type</span><span class="o">=</span><span class="n">init_pulse_type</span><span class="p">,</span> <span class="n">dyn</span><span class="o">=</span><span class="n">dyn</span><span class="p">,</span>
                                        <span class="n">pulse_params</span><span class="o">=</span><span class="n">init_pulse_params</span><span class="p">)</span>
        <span class="n">pgen</span><span class="o">.</span><span class="n">scaling</span> <span class="o">=</span> <span class="n">pulse_scaling</span>
        <span class="n">pgen</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">pulse_offset</span>
        <span class="n">pgen</span><span class="o">.</span><span class="n">lbound</span> <span class="o">=</span> <span class="n">amp_lbound</span>
        <span class="n">pgen</span><span class="o">.</span><span class="n">ubound</span> <span class="o">=</span> <span class="n">amp_ubound</span>

        <span class="n">optim</span><span class="o">.</span><span class="n">pulse_generator</span> <span class="o">=</span> <span class="n">pgen</span>

    <span class="k">if</span> <span class="n">log_level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Optimisation config summary...</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  object classes:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;    optimizer: &quot;</span> <span class="o">+</span> <span class="n">optim</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    dynamics: &quot;</span> <span class="o">+</span> <span class="n">dyn</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    tslotcomp: &quot;</span> <span class="o">+</span> <span class="n">dyn</span><span class="o">.</span><span class="n">tslot_computer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    fidcomp: &quot;</span> <span class="o">+</span> <span class="n">dyn</span><span class="o">.</span><span class="n">fid_computer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    propcomp: &quot;</span> <span class="o">+</span> <span class="n">dyn</span><span class="o">.</span><span class="n">prop_computer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    pulsegen: &quot;</span> <span class="o">+</span> <span class="n">pgen</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">optim</span></div>


</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, P.D. Nation, J.R. Johansson, A.J.G. Pitchford, C. Granade, and A.L. Grimsmo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>